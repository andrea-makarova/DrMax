<!doctype html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Move &amp; Mind – Přehled</title>
  <link rel="icon" href="images/Dr.Max.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Figtree:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/2c7f1c6cae.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    :root {
      --blue-25: #f5f8fd;
      --blue-50: #e5f1fe;
      --blue-200: #95ccfe;
      --blue-400: #3997dd;
      --blue-500: #0d77ba;
      --gray-50: #f1f1f1;
      --gray-100: #e2e2e2;
      --gray-300: #ababab;
      --gray-400: #919191;
      --gray-900: #1b1b1b;
      --green-300: #78be20;
      --green-500: #47850a;
      --red-500: #e4002b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: var(--blue-25);
      font-family: "Proxima Vara", "Proxima Nova", "Figtree", system-ui, -apple-system, sans-serif;
      color: var(--gray-900);
    }
    .font-sans {
      font-family: "Proxima Vara", "Proxima Nova", "Figtree", system-ui, -apple-system, sans-serif !important;
    }
    body.tutorial-active {
      overflow: hidden;
    }
    .page {
      max-width: 1080px;
      margin: 0 auto;
      padding: 70px 24px 140px;
    }
    .top-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 100;
      height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: #3a3a3c;
      border-bottom: 1px solid #e5e5ea;
      background: #ffffff;
      padding: 0;
    }
    .back-btn {
      position: absolute;
      left: 14px;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: transparent;
      display: grid;
      place-items: center;
      cursor: pointer;
      color: #3a3a3c;
      box-shadow: none;
    }
    .back-btn:active { transform: translateY(1px); }
    .top-title {
      margin: 0;
      font-size: 18px;
      font-weight: 700;
      color: #3a3a3c;
      line-height: 24px;
    }
    .top-actions {
      position: absolute;
      right: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .gear-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: transparent;
      display: grid;
      place-items: center;
      cursor: pointer;
    }
    .gear-btn img {
      width: 22px;
      height: 22px;
      display: block;
      filter: brightness(0) saturate(100%) invert(62%) sepia(7%) saturate(211%) hue-rotate(201deg) brightness(95%) contrast(88%);
    }
    .how-works-btn {
      background: #ffffff;
      color: #0d77ba;
      border: 1px solid #d7e6f6;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .how-works-btn:active { transform: translateY(1px); }
    .menu-open-btn {
      background: #ffffff;
      color: #3a3a3c;
      border: 1px solid #e1e5ea;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }
    .permissions-toggle {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #e1e5ea;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .permissions-toggle:active { transform: translateY(1px); }
    .generate-stamps-btn {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #e1e5ea;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .generate-stamps-btn:active { transform: translateY(1px); }
    .lockscreen-btn {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #e1e5ea;
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      text-decoration: none;
    }
    .lockscreen-btn:active { transform: translateY(1px); }
    .redeem-btn {
      background: #ffffff;
      color: #0d6fb8;
      border: none;
      border-radius: 999px;
      padding: 10px 22px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      min-width: 170px;
      text-align: center;
      transition: background 220ms ease, color 220ms ease, border-color 220ms ease, box-shadow 220ms ease;
    }
    .redeem-btn[disabled] {
      background: #eef0f4;
      color: #6b7280;
      border: 1px solid #e1e5ea;
      box-shadow: none;
      cursor: not-allowed;
    }
    .btn-disabled {
      background: #eef0f4;
      color: #6b7280;
      border: 1px solid #e1e5ea;
      box-shadow: none;
      cursor: not-allowed;
      transition: background 220ms ease, color 220ms ease, border-color 220ms ease, box-shadow 220ms ease;
    }
    .btn-disabled i { color: currentColor; }
    .reward-card {
      transition: background 260ms ease, color 260ms ease;
      box-shadow: none;
    }
    .reward-card:hover { box-shadow: none; }
    .reward-actions {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      width: 100%;
    }
    .perm-cta {
      font-size: 13px;
      font-weight: 700;
      color: #0d77ba;
      text-decoration: none;
      background: #ffffff;
      border: 1px solid #d7e6f6;
      border-radius: 999px;
      padding: 10px 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 170px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
    }
    .enable-pop {
      animation: enablePop 650ms cubic-bezier(0.2, 0.75, 0.25, 1);
    }
    @keyframes enablePop {
      0% { filter: brightness(0.97); }
      45% { filter: brightness(1.04); }
      100% { filter: brightness(1); }
    }
    .glass {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.8);
      border-radius: 24px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      backdrop-filter: blur(10px);
    }
    .card { padding: 20px; }
    .stamps-card {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      min-height: 170px;
      border: 1px solid #e5e5ea;
      border-radius: 24px;
      background: #ffffff;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
    }
    .stamps-card.ready {
      border-color: #bfe3a2;
      box-shadow: 0 8px 18px rgba(93, 162, 10, 0.18);
    }
    .stamp-ready-count {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eaf6dc;
      color: #2f6f0a;
      font-size: 12px;
      font-weight: 700;
      margin-left: auto;
    }
    .claim-all-btn {
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #ffffff;
      color: #0d77ba;
      border: 1px solid #d7e6f6;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
    }
    .stamps-title {
      font-size: 14px;
      font-weight: 700;
      color: #3a3a3c;
      margin: 0 10px 0 0;
      white-space: nowrap;
    }
    .stamps-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px 10px;
      width: 100%;
      align-items: center;
      justify-items: center;
    }
    .stamp-dot {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px dashed #d7dce5;
      background: #f7f8fb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #c0c4ce;
      font-size: 18px;
      position: relative;
      overflow: visible;
    }
    .stamp-icon {
      font-size: 18px;
      color: #2f6f0a;
    }
    .stamp-dot-filled {
      border-color: #5da20a;
      border-style: solid;
      background: linear-gradient(180deg, #eaf6dc 0%, #d8efbb 100%);
      box-shadow: 0 6px 14px rgba(93, 162, 10, 0.25);
      color: #2f6f0a;
    }
    .stamp-dot-ready {
      border-style: solid;
      border-color: #2f6f0a;
      background: #ffffff;
      box-shadow: 0 0 0 3px rgba(93, 162, 10, 0.18);
    }
    .stamp-dot-disabled {
      border-style: solid;
      background: #f1f2f6;
    }
    .stamp-gift-active {
      border: none;
      background: linear-gradient(180deg, #95DA39 0%, #5DA20A 100%);
      color: #ffffff;
      box-shadow: 0 8px 18px rgba(93,162,10,0.25);
    }
    .stamp-pop {
      animation: stampBounce 0.55s cubic-bezier(0.2, 0.9, 0.3, 1.2);
    }
    .bonus-card-pop {
      animation: bonusPop 0.9s cubic-bezier(0.25, 0.8, 0.3, 1) forwards;
      box-shadow: none;
    }
    .rewards-carousel {
      display: flex;
      gap: 12px;
      padding: 0 24px;
      margin: 0;
      margin-left: -20px;
      margin-right: -20px;
      width: calc(100% + 48px);
      overflow-x: auto;
      overflow-y: visible;
      position: relative;
      scroll-snap-type: x proximity;
    }
    .rewards-carousel::-webkit-scrollbar { display: none; }
    .rewards-carousel.reveal-card {
      overflow: visible !important;
      z-index: 4;
    }
    .rewards-carousel.scrolling-to-start {
      position: relative;
      overflow: visible !important;
    }
    .rewards-carousel.scrolling-to-start::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: linear-gradient(90deg, rgba(13,111,184,0.08), rgba(13,111,184,0));
      animation: scrollSweep 1.3s ease-out;
    }
    .stamps-card {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      min-height: 170px;
      border: 1px solid #e5e5ea;
      border-radius: 24px;
      background: #ffffff;
      box-shadow: 0 6px 20px rgba(15, 23, 42, 0.06);
      transform-style: preserve-3d;
    }
    .stamps-card.turning {
      animation: stampTurn 0.85s ease-in-out;
    }
    .bonus-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10030;
    }
    .bonus-modal.visible {
      display: flex;
    }
    .bonus-modal__overlay {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      backdrop-filter: blur(4px);
    }
    #daily-modal .bonus-modal__overlay {
      pointer-events: none;
    }
    .bonus-modal__content {
      position: relative;
      z-index: 1;
      max-width: 480px;
      width: 90%;
      border-radius: 24px;
      padding: 28px 24px;
      text-align: center;
      box-shadow: 0 22px 48px rgba(15,23,42,0.18);
      animation: modalLift 0.45s ease-out;
    }
    #bonus-modal {
      align-items: flex-end;
      padding: 64px 0 0;
    }
    #bonus-modal .bonus-modal__content {
      width: 100%;
      max-width: none;
      border-radius: 24px 24px 0 0;
      text-align: center;
      animation: drawerSlideUp 520ms ease-out both;
      background: #ffffff;
      box-shadow: 0 -12px 24px rgba(0, 0, 0, 0.12);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    #bonus-modal .bonus-close-x {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #f0f1f5;
      color: #6e6e73;
      display: grid;
      place-items: center;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }
    #daily-modal {
      align-items: stretch;
      padding: 0;
    }
    #daily-modal .bonus-modal__content {
      width: 100%;
      max-width: none;
      height: 100%;
      max-height: none;
      border-radius: 0;
      padding: 28px 24px 24px;
      text-align: left;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      animation: drawerSlideUp 520ms ease-out both;
      animation-delay: 0ms;
      background: #ffffff;
      box-shadow: none;
      display: flex;
      flex-direction: column;
    }
    #daily-modal .daily-modal-footer {
      margin-top: auto;
      padding-bottom: 12px;
    }
    .celebrate-icon {
      width: 84px;
      height: 84px;
      border-radius: 24px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, #95DA39 0%, #5DA20A 100%);
      display: grid;
      place-items: center;
      color: #ffffff;
      animation: iconPulse 1.4s ease-in-out infinite;
      position: relative;
      overflow: visible;
    }
    .celebrate-icon::after {
      content: "";
      position: absolute;
      inset: -10px;
      border-radius: 32px;
      border: 2px solid rgba(255,255,255,0.35);
      animation: iconRing 1.4s ease-in-out infinite;
    }
    .bonus-modal h3 {
      margin: 0 0 8px 0;
      font-size: 22px;
      font-weight: 800;
      color: #2f2f35;
    }
    .bonus-modal p {
      margin: 0 0 16px 0;
      color: #6e6e73;
      font-size: 14px;
      line-height: 20px;
    }
    .daily-modal-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 18px;
    }
    .daily-option {
      padding: 16px 16px;
      background: #ffffff;
      border: 1px solid #eceff3;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
      display: grid;
      grid-template-columns: 26px 1fr;
      gap: 14px;
      font-size: 18px;
      font-weight: 700;
      color: #2c3640;
      cursor: pointer;
      text-align: left;
      width: 100%;
    }
    .daily-option:last-child {
      margin-bottom: 0;
    }
    .daily-option small {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #5c5f6b;
      margin-top: 6px;
      line-height: 20px;
    }
    .daily-option small.daily-highlight {
      color: #000000;
      font-weight: 600;
    }
    .daily-option .radio {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid #bfc5d1;
      margin-top: 2px;
    }
    .daily-option.is-selected .radio {
      border-color: #5DA20A;
      background: linear-gradient(180deg, #95DA39 0%, #5DA20A 100%);
      box-shadow: inset 0 0 0 5px #ffffff;
    }
    .daily-complete-msg {
      color: #2f6f0a;
      font-weight: 600;
    }
    .daily-complete-msg span {
      font-weight: 700;
    }
    .daily-complete-panel {
      margin: -12px 24px 16px;
      padding: 18px 16px;
      border-radius: 20px;
      border: 0;
      background: linear-gradient(151deg, #95DA39 0%, #5DA20A 100%);
      display: none;
      align-items: center;
      gap: 14px;
      box-shadow: 0 8px 18px rgba(53,107,9,0.25);
    }
    .daily-complete-panel.is-visible {
      display: flex;
    }
    .daily-complete-icon {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #ffffff;
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }
    .daily-complete-icon svg path {
      fill: #2f6f0a;
    }
    .daily-complete-icon-mask {
      width: 26px;
      height: 26px;
      display: block;
      background: linear-gradient(180deg, #95DA39 0%, #5DA20A 100%);
      -webkit-mask: url("images/shoe-prints-solid-full.svg") center / contain no-repeat;
      mask: url("images/shoe-prints-solid-full.svg") center / contain no-repeat;
    }
    .daily-complete-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .daily-complete-title {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: #ffffff;
    }
    .daily-complete-subtitle {
      color: #ffffff;
    }
    .daily-complete-subtitle {
      margin: 0;
      font-size: 14px;
      color: #ffffff;
    }
    .tutorial-overlay {
      position: fixed;
      inset: 0;
      z-index: 10080;
      display: none;
      pointer-events: none;
    }
    .tutorial-overlay.is-visible {
      display: block;
    }
    .tutorial-mask {
      position: fixed;
      background: rgba(13, 21, 34, 0.12);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      pointer-events: none;
    }
    .tutorial-highlight {
      position: fixed;
      border-radius: 32px;
      border: none;
      transition: all 320ms ease-out;
      will-change: top, left, width, height, border-radius;
      pointer-events: none;
    }
    .tutorial-card {
      position: fixed;
      max-width: 260px;
      background: #3f4a55;
      color: #ffffff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
      pointer-events: auto;
    }
    .tutorial-stepper {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 18px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      pointer-events: auto;
      z-index: 1;
    }
    .tutorial-stepper__bar {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #ffffff;
      border-radius: 999px;
      padding: 8px 14px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.18);
    }
    .tutorial-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #d3d7df;
    }
    .tutorial-dot.is-active {
      background: #0d6fb8;
    }
    .tutorial-skip {
      border: none;
      background: #ffffff;
      color: #0d6fb8;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 700;
      box-shadow: 0 8px 20px rgba(15,23,42,0.18);
      cursor: pointer;
    }
    .tutorial-step {
      display: none;
    }
    .tutorial-text {
      font-size: 13px;
      line-height: 18px;
      margin: 0 0 10px;
    }
    .tutorial-actions {
      display: flex;
      justify-content: flex-end;
    }
    .tutorial-next {
      border: none;
      background: #ffffff;
      color: #0d6fb8;
      border: 1px solid #d7dce5;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 700;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      cursor: pointer;
    }
    .tutorial-active .stamps-row .stamp-dot {
      display: inline-flex;
    }
    .daily-info {
      background: #f0f1f5;
      color: #000000;
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0 14px;
      text-align: left;
    }
    .daily-highlight {
      background: #f0f1f5;
      color: #000000;
      border-radius: 4px;
      padding: 2px 6px;
      display: inline-block;
      font-size: 14px;
      font-weight: 600;
    }
    .daily-info-icon img {
      width: 34px;
      height: 34px;
      display: block;
      filter: brightness(0) saturate(100%) invert(60%) sepia(71%) saturate(501%) hue-rotate(39deg) brightness(97%) contrast(92%);
    }
    .daily-info span {
      font-weight: 600;
    }
    .daily-modal-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .daily-note {
      font-size: 14px;
      color: #9aa0aa;
      margin: 0;
      text-align: center;
    }
    .start-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      background: rgba(13, 21, 34, 0.45);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 9999;
    }
    .start-modal.open { display: flex; }
    .start-modal__sheet {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 24px 24px 0 0;
      padding: 20px 22px 26px;
      box-shadow: 0 -12px 24px rgba(0, 0, 0, 0.12);
      animation: drawerSlideUp 520ms ease-out both;
      animation-delay: 0ms;
    }
    .start-modal__close {
      margin-left: auto;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: #f0f1f5;
      color: #6e6e73;
      display: grid;
      place-items: center;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
    }
    .start-modal__title {
      margin: 10px 0 10px;
      font-size: 24px;
      font-weight: 800;
      color: #2c3640;
      line-height: 30px;
    }
    .start-modal__desc {
      margin: 0 0 16px;
      font-size: 16px;
      line-height: 22px;
      font-weight: 500;
      color: #3a3a3c;
    }
    .start-modal__highlight {
      background: #f0f1f5;
      color: #000000;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 14px;
      line-height: 20px;
      margin: 0 0 18px;
    }
    .drawer-cta {
      width: 100%;
      border: none;
      border-radius: 999px;
      background: #47850a;
      color: #ffffff;
      font-size: 16px;
      font-weight: 700;
      height: 44px;
      padding: 0 24px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(53,107,9,0.25);
    }
    .start-modal__cta {
      width: 100%;
      border: none;
      border-radius: 999px;
      background: #47850a;
      color: #ffffff;
      font-size: 16px;
      font-weight: 700;
      height: 44px;
      padding: 0 24px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(53,107,9,0.25);
    }
    .permission-drawer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: flex-end;
      justify-content: center;
      background: rgba(13, 21, 34, 0.45);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 10040;
    }
    .permission-drawer.open { display: flex; }
    .permission-drawer__sheet {
      width: 100%;
      max-width: none;
      height: 100%;
      background: #ffffff;
      border-radius: 0;
      padding: 32px 22px 32px;
      box-shadow: none;
      text-align: center;
      animation: drawerSlideUp 520ms ease-out both;
      display: flex;
      flex-direction: column;
    }
    .permission-drawer__icon {
      width: 64px;
      height: 64px;
      border-radius: 20px;
      margin: 4px auto 12px;
      background: linear-gradient(180deg, #95DA39 0%, #5DA20A 100%);
      color: #ffffff;
      display: grid;
      place-items: center;
      font-size: 28px;
    }
    .permission-drawer__title {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 800;
      color: #2c3640;
      line-height: 30px;
    }
    .permission-drawer__desc {
      margin: 0 0 16px;
      font-size: 16px;
      line-height: 22px;
      font-weight: 500;
      color: #3a3a3c;
    }
    .permission-drawer__highlight {
      margin: 0 0 18px;
      font-size: 16px;
      font-weight: 700;
      color: #2c3640;
    }
    .permission-stamp-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px 10px;
      justify-items: center;
      margin: 16px 0 18px;
    }
    .permission-stamp {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px dashed #d7dce5;
      background: #f7f8fb;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #c0c4ce;
      font-size: 18px;
    }
    .permission-stamp.filled {
      border-color: #5da20a;
      border-style: solid;
      background: linear-gradient(180deg, #eaf6dc 0%, #d8efbb 100%);
      box-shadow: 0 6px 14px rgba(93, 162, 10, 0.25);
      color: #2f6f0a;
    }
    .permission-stamp i {
      font-size: 18px;
      color: #2f6f0a;
    }
    .permission-drawer__note {
      margin: 0 0 18px;
      font-size: 15px;
      color: #5f6368;
      font-weight: 600;
    }
    .permission-drawer__note {
      margin-bottom: auto;
    }
    .bonus-close {
      margin-top: 24px;
      background: #e5f1fe;
      color: #0d6fb8;
      border: 1px solid #cbdcf6;
      border-radius: 999px;
      padding: 12px 18px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      min-width: 160px;
      box-shadow: 0 6px 16px rgba(13, 111, 184, 0.16);
      transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
    }
    #bonus-modal .bonus-close {
      width: 100%;
    }
    .bonus-close:hover { filter: brightness(0.98); box-shadow: 0 10px 20px rgba(13, 111, 184, 0.18); }
    .bonus-close:active { transform: translateY(1px); box-shadow: 0 6px 16px rgba(13, 111, 184, 0.16); }
    .bonus-code {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: #f5f8fd;
      color: #0d6fb8;
      border: 1px solid #d7dce5;
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: 0.6px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
    }
    .bonus-code i { color: #0d6fb8; font-size: 14px; }
    .confetti-piece {
      position: fixed;
      width: 8px;
      height: 14px;
      border-radius: 3px;
      opacity: 0.95;
      pointer-events: none;
      animation: confettiFall 1.2s ease-out forwards;
    }
    .confetti-piece {
      position: fixed;
      width: 8px;
      height: 14px;
      border-radius: 3px;
      opacity: 0.95;
      pointer-events: none;
      animation: confettiFall 1.2s ease-out forwards;
    }
    @keyframes stampBounce {
      0% { transform: translateY(-12px) scale(0.9); box-shadow: 0 0 0 rgba(93,162,10,0); opacity: 0.85; }
      40% { transform: translateY(8px) scale(1.15); box-shadow: 0 16px 28px rgba(93,162,10,0.32); opacity: 1; }
      70% { transform: translateY(-6px) scale(1.02); box-shadow: 0 10px 20px rgba(93,162,10,0.24); }
      100% { transform: translateY(0) scale(1); box-shadow: 0 8px 18px rgba(93,162,10,0.18); opacity: 1; }
    }
@keyframes bonusPop {
  0% { transform: translateY(18px) scale(0.96); box-shadow: none; opacity: 0; }
  55% { transform: translateY(-4px) scale(1.02); box-shadow: none; opacity: 1; }
  100% { transform: translateY(0) scale(1); box-shadow: none; opacity: 1; }
}
    @keyframes scrollSweep {
      0% { transform: translateX(-12%); opacity: 0.55; }
      100% { transform: translateX(100%); opacity: 0; }
    }
    @keyframes stampTurn {
      0% { transform: rotateY(0deg) scale(1); opacity: 1; }
      40% { transform: rotateY(75deg) scale(0.96); opacity: 0.5; }
      60% { transform: rotateY(100deg) scale(0.96); opacity: 0.4; }
      100% { transform: rotateY(0deg) scale(1); opacity: 1; }
    }
    @keyframes confettiFall {
      0% { transform: translate3d(var(--x, 0px), -10px, 0) rotate(0deg); opacity: 1; }
      100% { transform: translate3d(var(--x, 0px), 140px, 0) rotate(420deg); opacity: 0; }
    }
    @keyframes modalLift {
      0% { transform: translateY(14px) scale(0.97); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    @keyframes drawerSlideUp {
      0% { transform: translateY(100%); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    @keyframes drawerSlideDown {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(100%); opacity: 0; }
    }
    @keyframes iconPulse {
      0%, 100% { transform: scale(0.95); }
      50% { transform: scale(1.06); }
    }
    @keyframes iconRing {
      0% { transform: scale(0.9); opacity: 0.7; }
      100% { transform: scale(1.1); opacity: 0; }
    }
    .tabbar {
      position: fixed;
      bottom: 0px;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #ededed;
      display: grid;
  grid-template-columns: repeat(5, 1fr);
      padding: 16px 8px 16px;
      box-shadow: 0 -10px 24px rgba(0, 0, 0, 0.05);
      z-index: 10010;
      transform: translateZ(0);
      backface-visibility: hidden;
      will-change: transform;
    }
    .modal-open .tabbar {
      pointer-events: none;
      z-index: 1;
    }
    .tab {
      display: grid;
      place-items: center;
      gap: 2px;
      font-size: 12px;
      color: #8e8e93;
      text-decoration: none;
    }
    .tab-icon {
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .tab-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      filter: grayscale(1) brightness(0.8);
    }
    .tab.active { color: var(--green-500); font-weight: 700; }
    .tab:not(.active) { color: #8e8e93; }
    .tab.active .tab-icon img { filter: none; }
    .section-title { font-size: 20px; font-weight: 700; margin: 0; color: var(--gray-900); }
    .muted { color: var(--gray-400); font-size: 14px; }
    .entry-sticky {
      position: fixed;
      left: 16px;
      right: 16px;
      bottom: 92px;
      background: linear-gradient(151deg, #95da39 0%, #5da20a 100%);
      border: none;
      border-radius: 18px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
      padding: 12px 14px;
      z-index: 18;
      display: none;
      align-items: center;
      gap: 12px;
    }
    .entry-sticky-title {
      font-size: 14px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      flex: 1;
    }
    .entry-sticky-btn {
      border-radius: 999px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: #ffffff;
      color: #0d77ba;
      border: 1px solid #ffffff;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
      text-decoration: none;
      white-space: nowrap;
    }
    .seasonal-sticky {
      bottom: 92px;
    }
    .bar {
      height: 10px;
      border-radius: 999px;
      background: #f2f2f7;
      overflow: visible;
      position: relative;
    }
    .bar-dot {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: #E4002B;
      border: 5px solid #ffffff;
      top: 50%;
      left: 10px;
      transform: translate(-50%, -50%);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
    }
    .bar-fill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--green-300), var(--green-500));
    }
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--blue-50);
      color: var(--gray-900);
      font-size: 12px;
      font-weight: 600;
      border: 1px solid var(--gray-100);
    }
    .challenge-tag {
      position: absolute;
      top: 16px;
      right: 16px;
    }
    .is-hidden { display: none !important; }
    .challenge {
      margin-top: 18px;
      padding: 14px 16px;
      border-radius: 16px;
      background: rgba(13, 119, 186, 0.06);
      border: 1px solid #e5f1fe;
      color: #0d6fb8;
      font-size: 16px;
      line-height: 22px;
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.05);
      max-width: 520px;
      width: 100%;
    }
    .challenge strong { color: #0d6fb8; }
    .challenge button {
      margin-top: 10px;
      background:#47850a;
      color:#ffffff;
      border:1px solid #47850a;
      border-radius:999px;
      padding:10px 16px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 6px 14px rgba(53,107,9,0.18);
    }
    .challenge button:active { transform: translateY(1px); }
    .card-header-safe { position: relative; }
    .main-half-lock {
      position: absolute;
      inset: 35% 0 0 0;
      display: flex;
      align-items: flex-end;
      justify-content: flex-start;
      background: rgba(255,255,255,0.82);
      backdrop-filter: blur(8px);
      pointer-events: all;
      padding: 16px 24px 18px;
    }
    @media (max-width: 400px) {
      .card-tag {
        position: static !important;
        margin-top: 8px !important;
        align-self: flex-start !important;
      }
    }
    @keyframes breathe {
      0% { transform: scale(0.9); opacity: 0.7; }
      50% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(0.9); opacity: 0.7; }
    }
    .press-menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 18, 24, 0.4);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 9999;
    }
    .press-menu-overlay.open { display: flex; }
    .press-menu {
      width: min(420px, calc(100% - 32px));
      background: #ffffff;
      border-radius: 20px 20px 16px 16px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 18px 30px rgba(15, 18, 24, 0.2);
      font-family: "Proxima Vara", "Proxima Nova", sans-serif;
    }
    .press-menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      color: #3a3a3c;
      font-weight: 700;
      font-size: 15px;
    }
    .press-menu-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #f0f1f4;
      color: #3a3a3c;
      font-size: 18px;
      cursor: pointer;
    }
    .press-menu-btn {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 12px 16px;
      margin-top: 10px;
      background: #f7f7fb;
      color: #2c2c2e;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .press-menu-btn.primary {
      background: #47850a;
      color: #ffffff;
    }
    .menu-open-btn {
      background: #ffffff;
      color: #1f2937;
      border: 1px solid #e1e5ea;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .menu-open-btn:active { transform: translateY(1px); }
    .press-menu-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
      padding: 8px 4px;
      font-size: 14px;
      font-weight: 600;
      color: #2c2c2e;
    }
    .press-menu-switch {
      position: relative;
      width: 44px;
      height: 24px;
      display: inline-flex;
      align-items: center;
    }
    .press-menu-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .press-menu-slider {
      position: absolute;
      inset: 0;
      background: #d6d8de;
      border-radius: 999px;
      transition: background 0.2s ease;
    }
    .press-menu-slider::after {
      content: "";
      position: absolute;
      width: 18px;
      height: 18px;
      left: 3px;
      top: 3px;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.16);
      transition: transform 0.2s ease;
    }
    .press-menu-switch input:checked + .press-menu-slider {
      background: #47850a;
    }
    .press-menu-switch input:checked + .press-menu-slider::after {
      transform: translateX(20px);
    }
  </style>
</head>
<body>
  <main class="page">
    <div class="top-nav">
      <button class="back-btn" onclick="window.location.href='app-home.html'" aria-label="Zpět">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M14.5 5L8.5 11.5L14.5 18" stroke="#1b1b1b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
      <h1 class="top-title">Zdravý pohyb s Maxem</h1>
      <div class="top-actions">
        <button class="gear-btn" type="button" aria-label="Nastavení" id="settings-btn">
          <img src="images/gear-regular-full.svg" alt="">
        </button>
        <button class="menu-open-btn is-hidden" type="button" id="menu-open-btn">Menu</button>
      </div>
    </div>
    <section style="padding:20px 0px 28px;margin-bottom:24px;">
      <div style="display:flex;flex-direction:column;align-items:flex-start;gap:12px;text-align:left;">
        <div style="width:120px;position:relative;flex-shrink:0;">
          <svg xmlns="http://www.w3.org/2000/svg" width="88" height="88" viewBox="0 0 88 88" fill="none">
<path d="M44.9279 59.5715C44.8309 54.0181 46.8772 48.6548 50.6165 44.6615C54.3558 40.6682 59.4819 38.3719 64.867 38.2779C70.2521 38.1839 75.4551 40.2999 79.3315 44.1603C83.2079 48.0206 85.4401 53.3092 85.5371 58.8626C85.634 64.416 83.5877 69.7793 79.8484 73.7726C76.1091 77.7659 70.9831 80.0622 65.598 80.1562C60.2128 80.2502 55.0098 78.1342 51.1334 74.2739C47.257 70.4135 45.0248 65.1249 44.9279 59.5715ZM69.7466 47.9382C68.9181 47.3418 67.7906 47.3906 67.0124 48.0587L55.8945 57.5619C55.1578 58.1856 54.88 59.2378 55.2205 60.1627C55.5611 61.0877 56.418 61.6982 57.3768 61.6815L62.0159 61.6005L59.8815 67.805C59.546 68.7854 59.8896 69.8849 60.7184 70.4959C61.5471 71.1069 62.6744 71.0435 63.4526 70.3754L74.5705 60.8722C75.3071 60.2485 75.585 59.1964 75.2444 58.2714C74.9039 57.3464 74.0469 56.7359 73.0881 56.7527L68.4491 56.8336L70.5834 50.6291C70.9189 49.6487 70.5753 48.5492 69.7466 47.9382Z" fill="url(#paint0_linear_49145_52454)"/>
<path d="M37.5065 14.1882L39.6741 17.1613L41.7366 14.1144C45.1739 9.02162 50.7902 5.94176 56.8111 5.83666C67.1749 5.65576 75.7301 14.1755 75.9166 24.8632L75.9232 25.2413C75.9679 27.8005 75.5342 30.4263 74.72 33.0732C71.6242 31.8763 68.2562 31.2369 64.7452 31.2982C49.7987 31.5591 37.8906 44.2761 38.1597 59.6896C38.232 63.8338 39.175 67.7592 40.8162 71.2796C40.7457 71.2809 40.6893 71.2818 40.6188 71.2831C38.4332 71.3212 36.2642 70.69 34.5057 69.3389C24.0711 61.4192 4.01385 42.8165 3.72907 26.5014L3.72247 26.1234C3.53592 15.4357 11.7885 6.62254 22.1523 6.44164C28.1732 6.33654 33.8936 9.21852 37.5065 14.1882Z" fill="url(#paint1_linear_49145_52454)"/>
<defs>
<linearGradient id="paint0_linear_49145_52454" x1="44.9279" y1="59.5715" x2="85.5371" y2="58.8626" gradientUnits="userSpaceOnUse">
<stop stop-color="#E4002B"/>
<stop offset="1" stop-color="#FD5553"/>
</linearGradient>
<linearGradient id="paint1_linear_49145_52454" x1="39.4817" y1="6.13915" x2="40.6188" y2="71.2831" gradientUnits="userSpaceOnUse">
<stop stop-color="#95DA39"/>
<stop offset="1" stop-color="#5DA20A"/>
</linearGradient>
</defs>
</svg>
        </div>
     
      </div>
      <article class="bg-white rounded-[32px] shadow-sm relative overflow-hidden border border-[#e5e5ea] mb-6" id="main-challenge-card" style="margin-top:20px;">
        <div class="flex flex-col gap-1 pl-6 pr-6 pt-6 pb-3 relative card-header-safe">
          <div class="flex items-center justify-between gap-3">
            <p class="font-sans text-[13px] font-normal leading-[17px] text-[#8a8a93] uppercase tracking-[0.5px] mb-0">Dnešní cíl</p>
            <span class="tag card-tag challenge-tag" style="border:0; padding:6px 10px; display:inline-flex; align-items:center; gap:6px; background:#e8f6db; color:#2f6f0a;">
              <i class="fa-solid fa-stamp" style="color:#2f6f0a;font-size:13px;"></i>
              1 razítko
            </span>
          </div>
          <p class="font-sans text-[22px] font-semibold leading-[28px] text-[#3a3a3c]" id="daily-title">Pohoda – 7&nbsp;500 kroků</p>
          <p class="font-sans text-[14px] font-normal leading-[18px] text-[#8a8a93] mb-0 is-hidden" id="daily-complete-steps">Dnes jste ušli 8&nbsp;234 / 7&nbsp;500 kroků</p>
          <p class="font-sans text-[14px] font-normal leading-[18px] text-[#8a8a93]" id="daily-desc">
            Ještě 5&nbsp;345 kroků k dnešnímu razítku.
          </p>
          <p class="font-sans text-[14px] font-normal leading-[18px] daily-complete-msg is-hidden" id="daily-complete-msg">
            Dnešní cíl splněn. Další výzva začne za <span id="daily-countdown">23 h 59 min</span>.
          </p>
        </div>
        <div class="relative h-[220px] overflow-hidden challenge-progress is-hidden" id="daily-progress">
          <svg class="absolute top-[20px] h-[172px] w-[340px]" viewBox="0 0 380 210" preserveAspectRatio="xMaxYMid meet" fill="none" data-progress="64" style="overflow: visible; width:340px; right:0;">
            <defs>
              <linearGradient id="arcGreen" x1="51.5829" y1="-22.8751" x2="331.322" y2="-17.3927" gradientUnits="userSpaceOnUse">
                <stop stop-color="#95DA39" />
                <stop offset="1" stop-color="#5DA20A" />
              </linearGradient>
              <linearGradient id="arcRed" x1="0" y1="22.5" x2="45" y2="22.5" gradientUnits="userSpaceOnUse">
                <stop stop-color="#E4002B" />
                <stop offset="1" stop-color="#FD5553" />
              </linearGradient>
            </defs>
            <path d="M380 198H105C53.6375 198 12 156.362 12 105C12 53.6375 53.6375 12 105 12H380" stroke="#F2F2F7" stroke-width="18" />
            <path class="arc-progress" d="M380 198H105C53.6375 198 12 156.362 12 105C12 53.6375 53.6375 12 105 12H380" stroke="url(#arcGreen)" stroke-linecap="butt" stroke-width="18" pathLength="100" stroke-dasharray="0 100" />
            <circle class="arc-knob" r="16" fill="#E4002B" opacity="1" stroke="white" stroke-width="4" style="filter: drop-shadow(0 4px 10px rgba(0,0,0,0.18));"></circle>
            <text x="340" y="12" text-anchor="middle" dominant-baseline="middle" class="font-sans text-[12px]" fill="#6e6e73" id="daily-goal-label">5k</text>
            <text x="340" y="198" text-anchor="middle" dominant-baseline="middle" class="font-sans text-[12px]" fill="#ffffff" stroke="rgba(0,0,0,0.25)" stroke-width="0.4" paint-order="stroke">0</text>
          </svg>
        <div class="absolute top-[20px] h-[172px] w-[340px] flex items-center justify-center pointer-events-none" style="right:0;">
          <div class="text-center">
            <p class="font-sans text-[24px] font-semibold leading-[28px] text-[#3a3a3c] m-0" id="daily-steps-count">3,200 / 5,000</p>
            <p class="font-sans text-[13px] font-normal leading-[18px] text-[#8a8a93] m-0">kroků dnes</p>
          </div>
        </div>
        </div>
        <div style="padding:0 24px 24px;"></div>
        <div class="daily-complete-panel" id="daily-complete-panel" aria-live="polite">
          <div class="daily-complete-icon" aria-hidden="true">
            <span class="daily-complete-icon-mask" aria-hidden="true"></span>
          </div>
          <div class="daily-complete-text">
            <p class="daily-complete-title">Dnešní cíl splněn</p>
            <p class="daily-complete-subtitle">Další výzva začne zítra.</p>
          </div>
        </div>
      </article>
      <article class="bg-white rounded-[32px] shadow-sm relative overflow-hidden border border-[#e5e5ea] mb-6" style="position:relative;" id="entry-permission-card">
        <div class="flex flex-col gap-1 pl-6 pr-6 pt-6 pb-3 relative card-header-safe">
          <p class="font-sans text-[13px] font-normal leading-[17px] text-[#8a8a93] uppercase tracking-[0.5px] mb-2">Vstupní výzva</p>
          <p class="font-sans text-[22px] font-semibold leading-[28px] text-[#3a3a3c]">Připojit Android Health</p>
          <p class="font-sans text-[14px] font-normal leading-[18px] text-[#8a8a93]">
            Povolte přístup ke krokům a získejte hned 4 razítka.
          </p>
          <span class="tag card-tag challenge-tag" style="border:0; padding:6px 10px; display:inline-flex; align-items:center; gap:6px; background:#e8f6db; color:#2f6f0a;">
            <i class="fa-solid fa-stamp" style="color:#2f6f0a;font-size:13px;"></i>
            4 razítka
          </span>
        </div>
        <div style="display:flex;justify-content:flex-start;padding:0 24px 18px;">
          <button style="background:#47850a;color:#ffffff;border:1px solid #47850a;border-radius:999px;padding:12px 18px;font-size:15px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 8px 18px rgba(53,107,9,0.25);" onclick="window.location.href='permissions-android.html'">
            <i class="fa-solid fa-check" style="font-size:14px;color:#ffffff;"></i>
            Připojit zdravotní data
          </button>
        </div>
      </article>
      <div style="display:flex;align-items:center;justify-content:space-between;margin:40px 4px 12px;">
      <h2 id="stamps-remaining-title" style="margin:0;font-size:18px;font-weight:700;color:#3a3a3c;">Zbývají už jen 4 razítka k odměně</h2>
      </div>
      <div class="stamps-card" id="stamps-card" style="margin-top:0;">
        <div class="stamps-row" aria-label="Průběh razítek">
          <span class="stamp-dot"></span>
          <span class="stamp-dot"></span>
          <span class="stamp-dot"></span>
          <span class="stamp-dot"></span>
          <span class="stamp-dot"></span>
          <span class="stamp-dot"></span>
          <span class="stamp-dot"></span>
          <span class="stamp-dot stamp-dot-disabled" aria-label="Odměna uzamčena">
            <i class="fa-solid fa-gift" style="font-size:18px;color:#c0c4ce;"></i>
          </span>
        </div>
      </div>
      <div class="reward-card font-sans" id="bonus-reward-card" style="background:linear-gradient(151deg, #95DA39 0%, #5DA20A 100%);border:0;border-radius:24px;padding:16px 18px;color:#ffffff;box-shadow:0 6px 14px rgba(15,23,42,0.06);margin-top:14px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:48px;height:48px;border-radius:14px;background:#ffffff;display:flex;align-items:center;justify-content:center;color:#5DA20A;">
            <i class="fa-solid fa-gift" style="font-size:18px;"></i>
          </div>
          <div>
            <p id="bonus-reward-title" style="margin:0;font-size:16px;font-weight:700;line-height:20px;">Bonusová odměna</p>
            <p class="muted" id="bonus-reward-text" style="margin:2px 0 0;color:#ffffff;">10% sleva na produkty Dr. Max.</p>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-12" id="rewards-section">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <h2 style="margin:0;font-size:18px;font-weight:700;color:#3a3a3c;">Moje odměny</h2>
      </div>
      <div class="rewards-carousel">
        <!-- Daily steps stamp rewards -->
        <div class="reward-empty" style="padding:6px 0;color:#6e6e73;font-size:14px;font-weight:600;">Odměny se zde zobrazí po sesbírání všech razítek.</div>
      </div>
    </section>


  </main>

  <div class="entry-sticky" id="entry-challenge-sticky" aria-live="polite">
    <p class="entry-sticky-title">Synchronizujte Android Health a získáte 4 razítka.</p>
    <a class="entry-sticky-btn" href="permissions-android.html">
      Synchronizovat
    </a>
  </div>
  <div class="entry-sticky seasonal-sticky" id="seasonal-challenge-sticky" aria-live="polite">
    <p class="entry-sticky-title">Sezónní výzva odemčena</p>
    <button class="entry-sticky-btn" id="seasonal-start-btn" type="button">Spustit výzvu</button>
  </div>

  <nav class="tabbar">
    <a class="tab" href="app-home.html">
      <div class="tab-icon"><img src="images/Home.svg" alt=""></div>
      <span>E-shop</span>
    </a>
    <a class="tab" href="#">
      <div class="tab-icon"><img src="images/Rx.svg" alt=""></div>
      <span>Recepty</span>
    </a>
    <a class="tab" href="#">
      <div class="tab-icon"><img src="images/Cart.svg" alt=""></div>
      <span>Košík</span>
    </a>
    <a class="tab" href="#">
      <div class="tab-icon"><img src="images/Purchases.svg" alt=""></div>
      <span>Nákupy</span>
    </a>
    <a class="tab active" href="menu.html">
      <div class="tab-icon"><img src="images/Menu.svg" alt=""></div>
      <span>Menu</span>
    </a>
  </nav>

  <div id="daily-modal" class="bonus-modal" role="dialog" aria-modal="true" aria-labelledby="daily-modal-title" aria-describedby="daily-modal-desc">
    <div id="daily-modal-overlay" class="bonus-modal__overlay"></div>
    <div class="bonus-modal__content glass">
      <h3 id="daily-modal-title">Vyberte si svůj denní cíl</h3>
      <div class="daily-info">
        <span class="daily-info-icon" aria-hidden="true">
          <img src="images/lightbulb-regular-full.svg" alt="">
        </span>
        <span>Za poslední měsíc jste nachodila průměrně <strong>4 434 kroků</strong> za den.</span>
      </div>
      <div class="daily-modal-options">
        <button class="daily-option" type="button" data-steps="4500" data-discount="5">
          <span class="radio" aria-hidden="true"></span>
          <span>Start – 4 500 kroků</span>
        </button>
        <button class="daily-option is-selected" type="button" data-steps="7500" data-discount="10">
          <span class="radio" aria-hidden="true"></span>
          <span>
            Pohoda – 7 500 kroků
            <small>Kroky se sčítají během celého dne – nemusíte je ujít najednou.</small>
            <small class="daily-highlight">Doporučeno na základě vašeho průměru</small>
          </span>
        </button>
        <button class="daily-option" type="button" data-steps="10000" data-discount="15">
          <span class="radio" aria-hidden="true"></span>
          <span>Výzva – 10 000 kroků</span>
        </button>
      </div>
      <div class="daily-modal-footer">
        <button id="daily-modal-apply" class="drawer-cta" type="button">Nastavit cíl</button>
        <p class="daily-note">Cíle můžete později změnit</p>
      </div>
    </div>
  </div>

  <div id="bonus-modal" class="bonus-modal" role="dialog" aria-modal="true" aria-labelledby="bonus-modal-title" aria-describedby="bonus-modal-desc">
    <div id="bonus-modal-overlay" class="bonus-modal__overlay"></div>
    <div class="bonus-modal__content glass">
      <button class="bonus-close-x" type="button" aria-label="Zavřít">×</button>
      <div class="celebrate-icon">
        <i class="fa-solid fa-gift" style="font-size:30px;color:#ffffff;"></i>
      </div>
      <h3 id="bonus-modal-title">Skvělé!</h3>
      <p id="bonus-modal-desc">Nasbírali jste 8 razítek. Vaše bonusová odměna je 10% sleva.</p>
      <div style="margin-bottom:8px;">
        <span class="bonus-code">
          MOVE10
          <button class="copy-code" data-code="MOVE10" aria-label="Kopírovat kód" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
            <i class="fa-solid fa-copy" style="font-size:14px;"></i>
          </button>
        </span>
      </div>
      <button id="bonus-modal-close" class="bonus-close" type="button">Uložit kupón na později</button>
    </div>
  </div>

  <div id="tutorial-overlay" class="tutorial-overlay" aria-hidden="true">
    <div class="tutorial-mask" data-mask="top"></div>
    <div class="tutorial-mask" data-mask="left"></div>
    <div class="tutorial-mask" data-mask="right"></div>
    <div class="tutorial-mask" data-mask="bottom"></div>
    <div class="tutorial-highlight" id="tutorial-highlight"></div>
    <div class="tutorial-card" id="tutorial-card">
      <div class="tutorial-step" id="tutorial-step">2-1</div>
      <p class="tutorial-text" id="tutorial-text">Tady vidíte svůj dnešní cíl.</p>
      <div class="tutorial-actions">
        <button class="tutorial-next" id="tutorial-next" type="button">Další</button>
      </div>
    </div>
    <div class="tutorial-stepper" id="tutorial-stepper">
      <button class="tutorial-skip" id="tutorial-skip" type="button">Přeskočit tutorial</button>
      <div class="tutorial-stepper__bar" id="tutorial-stepper-bar">
        <span class="tutorial-dot" data-step="0"></span>
        <span class="tutorial-dot" data-step="1"></span>
        <span class="tutorial-dot" data-step="2"></span>
        <span class="tutorial-dot" data-step="3"></span>
      </div>
    </div>
  </div>

  <div id="start-modal" class="start-modal" role="dialog" aria-modal="true" aria-labelledby="start-modal-title">
    <div class="start-modal__sheet">
      <div style="display:flex;justify-content:flex-end;">
        <button class="start-modal__close" type="button" id="start-modal-close" aria-label="Zavřít">×</button>
      </div>
      <h2 class="start-modal__title" id="start-modal-title">Jste připraveni proměnit zdravý pohyb v zábavu?</h2>
      <p class="start-modal__desc">Abychom vám mohli přičítat razítka, potřebujeme přístup ke krokům a vzdálenosti.</p>
      <p class="start-modal__highlight">Nečteme žádné citlivé údaje a data používáme jen pro tuto funkci.</p>
      <button class="drawer-cta start-modal__cta" type="button" onclick="window.location.href='permissions-android.html'">Jdeme na to!</button>
    </div>
  </div>

  <div id="permission-drawer" class="permission-drawer" role="dialog" aria-modal="true" aria-labelledby="permission-drawer-title">
    <div class="permission-drawer__sheet">
      <div class="permission-drawer__icon" aria-hidden="true">
        <i class="fa-solid fa-thumbs-up"></i>
      </div>
      <h2 class="permission-drawer__title" id="permission-drawer-title">Skvělý start!</h2>
      <p class="permission-drawer__desc">Za to, že jste si vybrali cíl a zapojili se do hry, dostáváte rovnou 4 razítka.</p>
      <p class="permission-drawer__highlight" id="permission-drawer-remaining">Zbývají už jen 4 razítka k odměně</p>
      <div class="permission-stamp-grid" aria-label="Průběh">
        <span class="permission-stamp filled"><i class="fa-solid fa-check"></i></span>
        <span class="permission-stamp filled"><i class="fa-solid fa-check"></i></span>
        <span class="permission-stamp filled"><i class="fa-solid fa-check"></i></span>
        <span class="permission-stamp filled"><i class="fa-solid fa-check"></i></span>
        <span class="permission-stamp"></span>
        <span class="permission-stamp"></span>
        <span class="permission-stamp"></span>
        <span class="permission-stamp"></span>
      </div>
      <p class="permission-drawer__note">Další razítka získáte postupně za aktivní dny.</p>
      <button class="drawer-cta" type="button" id="permission-drawer-cta">Jdu sbírat další razítka</button>
    </div>
  </div>
  <div id="press-menu" class="press-menu-overlay" aria-hidden="true">
    <div class="press-menu" role="dialog" aria-modal="true" aria-label="Rychlé akce">
      <div class="press-menu-header">
        <span>Rychlé akce</span>
        <button class="press-menu-close" type="button" data-action="close">×</button>
      </div>
      <div class="press-menu-row">
        <span>Oprávnění</span>
        <label class="press-menu-switch">
          <input type="checkbox" id="press-permissions-toggle">
          <span class="press-menu-slider"></span>
        </label>
      </div>
      <button class="press-menu-btn" type="button" data-action="generate">Vygenerovat 3 razítka</button>
      <button class="press-menu-btn" type="button" data-action="reset">Resetovat prototyp</button>
      <button class="press-menu-btn primary" type="button" data-action="lockscreen">Uzamčená obrazovka</button>
    </div>
  </div>

  <script>
    localStorage.setItem('indexVisited', 'true');
    const bonusTitle = document.getElementById('bonus-reward-title');
    const bonusText = document.getElementById('bonus-reward-text');
    const filledCountInit = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
    if (localStorage.getItem('bonusRewardSaved') !== 'true') {
      localStorage.setItem('bonusRewardStage', 'first');
      localStorage.setItem('bonusRewardText', '10% sleva na produkty Dr. Max.');
      if (bonusTitle) bonusTitle.textContent = 'Bonusová odměna';
      if (bonusText) bonusText.textContent = '10% sleva na produkty Dr. Max.';
      localStorage.removeItem('bonusRewardSavedText');
    }
    if (filledCountInit === 0 && localStorage.getItem('permissionsGranted') !== 'true') {
      localStorage.removeItem('bonusRewardSaved');
    }
    if (!localStorage.getItem('bonusRewardTitle')) {
      localStorage.setItem('bonusRewardTitle', 'Bonusová odměna');
    }
    if (localStorage.getItem('bonusRewardStage') === 'second') {
      localStorage.setItem('bonusRewardText', '15% sleva na produkty Dr. Max');
    } else if (!localStorage.getItem('bonusRewardText')) {
      localStorage.setItem('bonusRewardText', '10% sleva na produkty Dr. Max.');
    }
    if (bonusTitle) {
      bonusTitle.textContent = localStorage.getItem('bonusRewardTitle') || 'Bonusová odměna';
    }
    if (bonusText) {
      bonusText.textContent = localStorage.getItem('bonusRewardText') || '10% sleva na produkty Dr. Max.';
    }

    if (localStorage.getItem('prototypeSeeded') !== 'true') {
      localStorage.setItem('prototypeSeeded', 'true');
      localStorage.setItem('permissionsGranted', 'true');
      localStorage.removeItem('permissionsJustGranted');
      localStorage.setItem('manualGeneratedCount', '3');
      localStorage.setItem('stampFillCount', '3');
      localStorage.setItem('notificationStampCount', '0');
      localStorage.setItem('permissionsBonusCount', '0');
      localStorage.setItem('dailyGoalSteps', '7500');
      localStorage.setItem('dailyGoalDiscount', '10');
      localStorage.setItem('dailyCurrentSteps', '4578');
      localStorage.removeItem('dailyCompleted');
      localStorage.removeItem('dailyCompleteUntil');
    }

    const setPermissionsGranted = (next) => {
      localStorage.setItem('permissionsGranted', next ? 'true' : 'false');
      if (next) {
        localStorage.setItem('permissionsJustGranted', 'true');
      } else {
        localStorage.removeItem('permissionsJustGranted');
        localStorage.removeItem('openDailyOnReturn');
      }
      syncPermissionsState();
    };

    const generateStamps = (count = 3) => {
      const total = Math.max(0, Number(count) || 0);
      if (!total) return;
      const manualCount = parseInt(localStorage.getItem('manualGeneratedCount') || '0', 10);
      localStorage.setItem('manualGeneratedCount', String(manualCount + total));
      localStorage.setItem('permissionsGranted', 'true');
      syncPermissionsState();
      document.body.dataset.suppressReady = 'true';
      localStorage.setItem('dailyCurrentSteps', '3256');
      updateDailyProgressTo(3256);
      forceScrollToStampsCard();
      addStampsSequential(total, 450);
      setTimeout(() => {
        document.body.dataset.suppressReady = '';
        updateStampReadyState();
      }, total * 450 + 200);
    };

    const menuAction = localStorage.getItem('menuAction');
    if (menuAction) {
      localStorage.removeItem('menuAction');
      if (menuAction === 'generate') {
        generateStamps(3);
      } else if (menuAction === 'lockscreen') {
        window.location.href = 'lockscreen-notification.html';
      } else if (menuAction === 'reset') {
        localStorage.clear();
        window.location.href = 'app-home.html';
      }
    }

    const suppressDrawers = localStorage.getItem('suppressDrawersOnIndex') === 'true';
    if (suppressDrawers) {
      localStorage.removeItem('suppressDrawersOnIndex');
    }

    // Animate arc progress when the card scrolls into view
    const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);

    const animateArc = (svg) => {
      const target = Math.max(0, Math.min(100, parseFloat(svg.dataset.progress || '0')));
      const path = svg.querySelector('.arc-progress');
      const knob = svg.querySelector('.arc-knob');
      if (!path || !knob || svg.dataset.animated === 'true') return;

      const totalLen = path.getTotalLength();
      const duration = 2200;
      const start = performance.now();

      const step = (now) => {
        const t = Math.min(1, (now - start) / duration);
        const eased = easeOutCubic(t);
        const current = target * eased;

        path.setAttribute('stroke-dasharray', `${current} ${100 - current}`);
        const point = path.getPointAtLength((current / 100) * totalLen);
        knob.setAttribute('cx', point.x);
        knob.setAttribute('cy', point.y);

        if (t < 1) {
          requestAnimationFrame(step);
        } else {
          svg.dataset.animated = 'true';
        }
      };

      // Init at zero and start
      path.setAttribute('stroke-dasharray', `0 100`);
      const startPoint = path.getPointAtLength(0);
      knob.setAttribute('cx', startPoint.x);
      knob.setAttribute('cy', startPoint.y);
      requestAnimationFrame(step);
    };

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            animateArc(entry.target);
            observer.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.25, rootMargin: '0px 0px -10% 0px' }
    );

    document.querySelectorAll('svg[data-progress]').forEach((svg) => {
      const path = svg.querySelector('.arc-progress');
      const knob = svg.querySelector('.arc-knob');
      if (path && knob) {
        // Reset to zero until animated
        path.setAttribute('stroke-dasharray', `0 100`);
        const startPoint = path.getPointAtLength(0);
        knob.setAttribute('cx', startPoint.x);
        knob.setAttribute('cy', startPoint.y);
        observer.observe(svg);
      }
    });

    // Animate straight mobility progress
    const animateStraight = (track) => {
      const target = Math.max(0, Math.min(100, parseFloat(track.dataset.progress || '0')));
      const fill = track.querySelector('.mobility-progress-fill');
      const dot = track.querySelector('.mobility-progress-dot');
      if (!fill || !dot || track.dataset.animated === 'true') return;

      const duration = 1800;
      const start = performance.now();

      const step = (now) => {
        const t = Math.min(1, (now - start) / duration);
        const eased = easeOutCubic(t);
        const current = target * eased;

        fill.style.width = `${current}%`;
        dot.style.left = `${current}%`;

        if (t < 1) {
          requestAnimationFrame(step);
        } else {
          track.dataset.animated = 'true';
        }
      };

      fill.style.width = '0%';
      dot.style.left = '0%';
      requestAnimationFrame(step);
    };

    const straightObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            animateStraight(entry.target);
            straightObserver.unobserve(entry.target);
          }
        });
      },
      { threshold: 0.3, rootMargin: '0px 0px -10% 0px' }
    );

    document.querySelectorAll('.mobility-progress[data-progress]').forEach((track) => {
      const fill = track.querySelector('.mobility-progress-fill');
      const dot = track.querySelector('.mobility-progress-dot');
      if (fill && dot) {
        fill.style.width = '0%';
        dot.style.left = '0%';
        straightObserver.observe(track);
      }
    });

    const wireRewardActions = (root = document) => {
      root.querySelectorAll('.copy-code').forEach((copyBtn) => {
        if (copyBtn.dataset.wired === 'true') return;
        copyBtn.dataset.wired = 'true';
        copyBtn.addEventListener('click', (evt) => {
          evt.stopPropagation();
          const code = copyBtn.dataset.code || '';
          if (!code) return;
          navigator.clipboard?.writeText(code).catch(() => {});
          copyBtn.innerHTML = '<i class="fa-solid fa-check" style="font-size:14px;color:#0d6fb8;"></i>';
          setTimeout(() => {
            copyBtn.innerHTML = '<i class="fa-solid fa-copy" style="font-size:14px;"></i>';
          }, 1200);
        });
      });

      root.querySelectorAll('.add-to-cart-btn').forEach((addBtn) => {
        if (addBtn.dataset.wired === 'true') return;
        addBtn.dataset.wired = 'true';
        addBtn.addEventListener('click', (evt) => {
          evt.stopPropagation();
          addBtn.disabled = true;
          addBtn.innerHTML = '<i class="fa-solid fa-check" style="color:#0d6fb8;font-size:14px;"></i> Added to cart';
        });
      });
    };

    wireRewardActions();

    const unlockBonusReward = () => {
      const allStamps = Array.from(document.querySelectorAll('.stamps-row .stamp-dot'));
      if (allStamps.length === 0) return;
      const allFilled = allStamps.every((stamp) => stamp.classList.contains('stamp-dot-filled') || stamp.classList.contains('stamp-gift-active'));
      if (!allFilled) return;

      if (document.body.dataset.bonusPending === 'true') return;
      document.body.dataset.bonusPending = 'true';
      const bonusTitle = document.getElementById('bonus-reward-title');
      const bonusText = document.getElementById('bonus-reward-text');
      if (bonusTitle) bonusTitle.textContent = 'Bonusová odměna';
      if (bonusText) bonusText.textContent = '10% sleva na produkty Dr. Max.';
      localStorage.setItem('bonusRewardStage', 'first');
      localStorage.setItem('bonusRewardTitle', 'Bonusová odměna');
      localStorage.setItem('bonusRewardText', '10% sleva na produkty Dr. Max.');
      setTimeout(() => {
        launchConfetti();
        openBonusModal();
      }, 1000);
    };


    function updateSeasonalVisibility() {
      const section = document.getElementById('seasonal-section');
      if (!section) return;
      const filledCount = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
      const started = localStorage.getItem('seasonalStarted') === 'true';
      const unlocked = started || filledCount >= 4;
      if (unlocked) {
        localStorage.setItem('seasonalUnlocked', 'true');
      } else {
        localStorage.removeItem('seasonalUnlocked');
      }
      section.classList.toggle('is-hidden', !unlocked);
      updateSeasonalStickyImmediate();
    }

    const getStampLabel = (count) => {
      if (count === 1) return 'razítko';
      if (count >= 2 && count <= 4) return 'razítka';
      return 'razítek';
    };

    const updateRemainingStamps = () => {
      const filled = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
      const remaining = Math.max(0, 8 - filled);
      const verb = remaining === 1 ? 'Zbývá' : 'Zbývají';
      const label = getStampLabel(remaining);
      const text = `${verb} už jen ${remaining} ${label} k odměně`;
      const title = document.getElementById('stamps-remaining-title');
      const drawerText = document.getElementById('permission-drawer-remaining');
      if (title) title.textContent = text;
      if (drawerText) drawerText.textContent = text;
    };

    const updateStampReadyState = () => {
      const stampsCard = document.querySelector('.stamps-card');
      const stampCta = document.getElementById('stamp-ready-cta');
      const claimAllBtn = document.getElementById('claim-all-stamps');
      if (stampsCard) stampsCard.classList.remove('ready');
      if (stampCta) {
        stampCta.classList.add('is-hidden');
        stampCta.disabled = true;
      }
      if (claimAllBtn) {
        claimAllBtn.classList.add('is-hidden');
        claimAllBtn.disabled = true;
      }
      document.querySelectorAll('.stamps-row .stamp-dot').forEach((stamp) => {
        stamp.classList.remove('stamp-dot-ready');
      });
      updateRemainingStamps();
    };

    const scrollToStampsCard = () => {
      const target = document.getElementById('stamps-card');
      if (!target) return;
      const offset = 16;
      const scrollRoot = document.scrollingElement || document.documentElement;
      const top = target.getBoundingClientRect().top + window.scrollY - offset;
      requestAnimationFrame(() => {
        target.scrollIntoView({ behavior: 'auto', block: 'start' });
        window.scrollTo({ top, behavior: 'auto' });
        scrollRoot.scrollTop = top;
      });
      setTimeout(() => {
        const retryTop = target.getBoundingClientRect().top + window.scrollY - offset;
        window.scrollTo({ top: retryTop, behavior: 'auto' });
        scrollRoot.scrollTop = retryTop;
      }, 200);
    };

    const forceScrollToStampsCard = (behavior = 'smooth') => {
      const target = document.getElementById('stamps-card');
      if (!target) return;
      const offset = 16;
      const root = document.documentElement;
      const body = document.body;
      const originalBehavior = root.style.scrollBehavior;
      const originalOverflow = body.style.overflow;
      root.style.scrollBehavior = behavior;
      body.style.overflow = 'auto';

      const applyScroll = () => {
        const top = target.getBoundingClientRect().top + window.scrollY - offset;
        window.scrollTo({ top, behavior });
        root.scrollTop = top;
        body.scrollTop = top;
        target.scrollIntoView({ block: 'start', behavior });
      };

      let attempts = 0;
      const maxAttempts = 8;
      const tryScroll = () => {
        applyScroll();
        const rect = target.getBoundingClientRect();
        const inView = rect.top >= 0 && rect.top <= 40;
        attempts += 1;
        if (!inView && attempts < maxAttempts) {
          setTimeout(tryScroll, 150);
        } else {
          root.style.scrollBehavior = originalBehavior;
          body.style.overflow = originalOverflow;
        }
      };
      tryScroll();
      if (location.hash !== '#stamps-card') {
        location.hash = 'stamps-card';
        setTimeout(() => {
          history.replaceState({}, '', window.location.pathname + window.location.search);
        }, 200);
      }
    };

    const addStamp = (options = {}) => {
      const { animate = true } = options;
      const allStamps = Array.from(document.querySelectorAll('.stamps-row .stamp-dot:not(.stamp-dot-disabled)'));
      const baseline = Math.max(0, parseInt(document.body.dataset.stampBaseline || '0', 10));
      const stamps = baseline > 0 ? allStamps.slice(baseline) : allStamps;
      const next = stamps.find((stamp) => stamp && stamp.dataset.filled !== 'true');
      if (!next) {
        const filledCount = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
        localStorage.setItem('stampFillCount', String(filledCount));
        const gift = document.querySelector('.stamp-dot-disabled');
        if (gift) {
          gift.classList.add('stamp-gift-active', 'stamp-pop');
          gift.querySelector('i')?.setAttribute('style', 'font-size:18px;color:#ffffff;');
          setTimeout(() => gift.classList.remove('stamp-pop'), 600);
        }
        unlockBonusReward();
        updateSeasonalVisibility();
        return;
      }
      next.dataset.filled = 'true';
      next.classList.add('stamp-dot-filled');
      if (!next.querySelector('i')) {
        const icon = document.createElement('i');
        icon.className = 'fa-solid fa-check stamp-icon';
        next.appendChild(icon);
      }
      if (animate) {
        next.classList.add('stamp-pop');
        setTimeout(() => next.classList.remove('stamp-pop'), 600);
      }
      unlockBonusReward();
      updateSeasonalVisibility();
      updateStampReadyState();
      const filledCount = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
      localStorage.setItem('stampFillCount', String(filledCount));
    };

    const addStampsSequential = (count, delay = 450) => {
      for (let i = 0; i < count; i += 1) {
        setTimeout(() => addStamp(), i * delay);
      }
    };

    const ensureMinimumStamps = (minCount) => {
      const filled = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
      const needed = Math.max(0, minCount - filled);
      if (needed > 0) {
        addStampsSequential(needed, 300);
      }
    };

    const restoreBonusStamps = (count) => {
      const filled = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
      const needed = Math.max(0, count - filled);
      for (let i = 0; i < needed; i += 1) {
        addStamp({ animate: false });
      }
    };

    const permissionDrawer = document.getElementById('permission-drawer');
    const permissionDrawerCta = document.getElementById('permission-drawer-cta');
    const openPermissionDrawer = () => {
      if (suppressDrawers) return;
      if (!permissionDrawer) return;
      permissionDrawer.classList.add('open');
      document.body.classList.add('modal-open');
    };
    const closePermissionDrawer = () => {
      if (!permissionDrawer) return;
      permissionDrawer.classList.remove('open');
      document.body.classList.remove('modal-open');
    };
    permissionDrawerCta?.addEventListener('click', () => {
      document.body.dataset.suppressReady = '';
      document.body.dataset.stampBaseline = '';
      closePermissionDrawer();
      forceScrollToStampsCard();
      if (localStorage.getItem('pendingPermissionStamps') === 'true') {
        const currentFill = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
        const needed = Math.max(0, 4 - currentFill);
        if (needed > 0) {
          setTimeout(() => {
            addStampsSequential(needed, 500);
          }, 300);
        }
        setTimeout(() => {
          ensureMinimumStamps(4);
          localStorage.removeItem('pendingPermissionStamps');
        }, needed * 500 + 600);
      }
      const dailyProgress = document.getElementById('daily-progress');
      const savedGoal = Number(localStorage.getItem('dailyGoalSteps') || dailyProgress?.dataset.target || '5000');
      const savedDiscount = Number(localStorage.getItem('dailyGoalDiscount') || '10');
      applyDailyGoal(savedGoal, savedDiscount);
      if (dailyProgress && dailyProgress.dataset.started !== 'true') {
        startDailyChallenge(savedGoal);
      }
      if (dailyProgress) {
        dailyProgress.dataset.started = 'true';
        dailyProgress.classList.remove('is-hidden');
      }
      const currentSteps = 4200;
      localStorage.setItem('dailyCurrentSteps', '4200');
      setTimeout(() => {
        animateDailyProgressTo(currentSteps);
      }, 120);
    });


    // Convert a reward card to claimed state when its button is clicked
    const handleRewardClaim = (btn, options = {}) => {
      const { animate = true, track = true } = options;
      const card = btn.closest('.reward-card');
      if (!card || card.dataset.claimed === 'true' || btn.disabled) return;

      card.dataset.claimed = 'true';
      card.style.background = '#ffffff';
      card.style.border = '1px solid #e5e5ea';
      card.style.color = '#3a3a3c';
      card.style.transition = 'all 0.35s ease';
      if (animate) {
        card.animate(
          [
            { transform: 'scale(1)', boxShadow: card.style.boxShadow || 'none' },
            { transform: 'scale(1)', boxShadow: '0 8px 20px rgba(0,0,0,0.08)' },
            { transform: 'scale(1)', boxShadow: '0 6px 14px rgba(0,0,0,0.06)' }
          ],
          { duration: 320, easing: 'ease-out' }
        );
      }

      const actions = btn.closest('.reward-actions') || btn.parentElement;
      if (actions) {
        const type = card.dataset.rewardType || 'code';
        if (type === 'product') {
          const productName = card.dataset.productName || 'Odměna';
          actions.innerHTML = `
            <button class="add-to-cart-btn" style="background:#ffffff;color:#0d6fb8;border:1px solid #e5e5ea;border-radius:999px;padding:10px 18px;font-size:14px;font-weight:700;cursor:pointer;min-width:170px;text-align:center;display:inline-flex;align-items:center;gap:8px;justify-content:center;">
              <i class="fa-solid fa-cart-plus" style="color:#0d6fb8;font-size:14px;"></i>
              Add to cart
            </button>
          `;
        } else if (type === 'stamp') {
          if (track) {
            const count = parseInt(localStorage.getItem('claimedStampCount') || '0', 10);
            localStorage.setItem('claimedStampCount', String(count + 1));
          }
          const stampDate = card.dataset.stampDate ? ` ${card.dataset.stampDate}` : '';
          actions.innerHTML = `
            <button style="background:#eaf6dc;color:#2f6f0a;border:1px solid #d5e8b2;border-radius:999px;padding:10px 18px;font-size:14px;font-weight:700;cursor:default;min-width:170px;text-align:center;display:inline-flex;align-items:center;gap:8px;justify-content:center;">
              <i class="fa-solid fa-circle-check" style="font-size:14px;color:#2f6f0a;"></i>
              Uplatněno${stampDate ? ' - ' + stampDate : ''}
            </button>
          `;
        } else {
          const code = card.dataset.rewardCode || 'THANKS10';
          actions.innerHTML = `
            <span class="claim-code-pill" style="display:inline-flex;align-items:center;gap:10px; background:#ffffff; color:#0d6fb8; border:1px solid #e5e5ea; border-radius:999px; padding:10px 18px; font-size:14px; font-weight:700;min-width:170px;justify-content:center;">
              <span style="letter-spacing:0.6px;">${code}</span>
            <button class="copy-code" data-code="${code}" aria-label="Kopírovat kód" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#0d6fb8;">
                <i class="fa-solid fa-copy" style="font-size:14px;"></i>
              </button>
            </span>
          `;
        }

        const pill = actions.querySelector('span,button');
        if (pill) {
          pill.style.opacity = '0';
          pill.style.transition = 'opacity 0.35s ease';
          requestAnimationFrame(() => {
            pill.style.opacity = '1';
          });
        }

        wireRewardActions(actions);
      }

      const icon = card.querySelector('.reward-main-icon');
      if (icon) {
        icon.style.background = 'none';
        icon.style.webkitTextFillColor = '#ffffff';
        icon.style.color = '#ffffff';
        icon.style.fontSize = '26px';
        const iconWrap = icon.parentElement;
        if (iconWrap) iconWrap.style.background = 'linear-gradient(180deg, #95DA39 0%, #5DA20A 100%)';
      }

      addStamp({ animate });
      if (document.body.dataset.suppressReady === 'true') {
        document.body.dataset.suppressReady = '';
      }
      updateStampReadyState();
    };

    const restoreClaimedStamps = () => {
      if (document.body.dataset.claimsRestored === 'true') return;
      const count = parseInt(localStorage.getItem('claimedStampCount') || '0', 10);
      if (!count) return;
      const cards = Array.from(document.querySelectorAll('.reward-card[data-reward-type="stamp"]'))
        .filter((card) => card.dataset.claimed !== 'true');
      cards.slice(0, count).forEach((card) => {
        const btn = card.querySelector('.redeem-btn');
        if (btn && !btn.disabled) {
          handleRewardClaim(btn, { animate: false, track: false });
        }
      });
      document.body.dataset.claimsRestored = 'true';
    };

    const restoreNotificationStamps = () => {
      const granted = localStorage.getItem('permissionsGranted') === 'true';
      if (localStorage.getItem('notificationFlow') === 'true') return;
      if (!granted || document.body.dataset.notificationStampsRestored === 'true') return;
      const count = parseInt(localStorage.getItem('notificationStampCount') || '0', 10);
      if (!count) return;
      for (let i = 0; i < count; i += 1) {
        addStamp({ animate: false });
      }
      document.body.dataset.notificationStampsRestored = 'true';
    };

    const runNotificationFlow = () => {
      if (localStorage.getItem('permissionsGranted') !== 'true') return;
      document.body.dataset.suppressReady = 'true';
      requestAnimationFrame(() => {
        forceScrollToStampsCard();
      });
      setTimeout(() => {
        if (localStorage.getItem('notificationStampPending') === 'true') {
          const targetFill = parseInt(localStorage.getItem('notificationTargetFill') || '0', 10);
          if (targetFill > 0) {
            const currentFill = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
            const needed = Math.max(0, targetFill - currentFill);
            if (needed > 0) {
              for (let i = 0; i < needed - 1; i += 1) {
                addStamp({ animate: false });
              }
              addStamp({ animate: true });
            }
            localStorage.setItem('stampFillCount', String(targetFill));
            const goalSteps = parseInt(localStorage.getItem('dailyGoalSteps') || '0', 10);
            if (goalSteps > 0) {
              localStorage.setItem('dailyCurrentSteps', String(goalSteps));
              updateDailyProgressTo(goalSteps);
            }
            const nextMidnight = new Date();
            nextMidnight.setHours(24, 0, 0, 0);
            localStorage.setItem('dailyCompleteUntil', String(nextMidnight.getTime()));
            localStorage.setItem('dailyCompleted', 'true');
            setDailyCompleteState(true);
            startDailyCountdown();
          } else {
            const currentFill = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
            addStampsSequential(1, 500);
            localStorage.setItem('stampFillCount', String(currentFill + 1));
          }
          document.body.dataset.suppressReady = '';
          localStorage.removeItem('notificationFlow');
          localStorage.removeItem('notificationStampPending');
          localStorage.removeItem('notificationTargetFill');
        }
      }, 400);
    };

    const addNotificationStamp = () => {
      if (localStorage.getItem('permissionsGranted') !== 'true') return;
      const manualCount = parseInt(localStorage.getItem('manualGeneratedCount') || '0', 10);
      const bonusCount = parseInt(localStorage.getItem('permissionsBonusCount') || '0', 10);
      const notificationCount = parseInt(localStorage.getItem('notificationStampCount') || '0', 10);
      const storedFill = parseInt(localStorage.getItem('stampFillCount') || '0', 10);
      const baseTotal = Math.max(storedFill, manualCount + bonusCount + notificationCount);
      localStorage.setItem('notificationStampCount', String(notificationCount + 1));
      localStorage.setItem('notificationTargetFill', String(baseTotal + 1));
      localStorage.setItem('stampFillCount', String(baseTotal + 1));
      localStorage.setItem('notificationFlow', 'true');
      localStorage.setItem('notificationStampPending', 'true');
    };

    const autoClaimAvailableStamps = () => {
      const cards = Array.from(document.querySelectorAll('.reward-card[data-reward-type="stamp"]'))
        .filter((card) => card.dataset.claimed !== 'true');
      cards.forEach((card, index) => {
        const btn = card.querySelector('.redeem-btn');
        if (!btn || btn.disabled) return;
        setTimeout(() => handleRewardClaim(btn), index * 700);
      });
    };

    document.addEventListener('click', (event) => {
      const btn = event.target.closest('.reward-card button');
      if (!btn) return;
      event.preventDefault();
      handleRewardClaim(btn);
    });

    const claimAllHandler = () => {
      const buttons = Array.from(document.querySelectorAll('.reward-card[data-reward-type="stamp"] .redeem-btn'))
        .filter((btn) => btn && !btn.disabled);
      buttons.forEach((btn) => handleRewardClaim(btn));
      updateStampReadyState();
    };

    document.getElementById('claim-all-stamps')?.addEventListener('click', claimAllHandler);
    document.getElementById('stamp-ready-cta')?.addEventListener('click', claimAllHandler);

    // Breathing coach start handler with 4-4-4-4 timing and matching bubble scales
    const breathPhases = [
      { label: 'Inhale', duration: 4000, scale: 1.1, transition: 4000 },
      { label: 'Hold', duration: 4000, scale: 1.1, transition: 0 },
      { label: 'Exhale', duration: 4000, scale: 0.9, transition: 4000 },
      { label: 'Hold', duration: 4000, scale: 0.9, transition: 0 }
    ];
    let breathTimeout;
    let breathSessionInterval;
    let totalDuration = 60000; // default 1 min
    let selectedDuration = 1;
    let isQuickMode = false;
    const breathBtn = document.getElementById('breathing-start');
    const breathBubble = document.getElementById('breathing-bubble');
    const breathLabel = document.getElementById('breathing-label');
    const breathStatus = document.getElementById('breathing-status');
    const breathCounter = document.getElementById('breathing-counter');

    const setBubbleScale = (scale, ms) => {
      if (!breathBubble) return;
      breathBubble.style.transition = `transform ${ms}ms ease-in-out`;
      breathBubble.style.transform = `scale(${scale})`;
    };

    const renderRestControls = () => {
      const controls = document.getElementById('breath-controls');
      if (!controls) return;
      controls.innerHTML = `
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
          <button class="breath-duration" data-duration="1" style="background:#ffffff;color:#1d73c5;border:1px solid #d7dce5;border-radius:999px;padding:10px 18px;font-size:14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">1 min</button>
          <button class="breath-duration" data-duration="5" style="background:#ffffff;color:#1d73c5;border:1px solid #d7dce5;border-radius:999px;padding:10px 18px;font-size:14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">5 min</button>
          <button class="breath-duration" data-duration="10" style="background:#ffffff;color:#1d73c5;border:1px solid #d7dce5;border-radius:999px;padding:10px 18px;font-size:14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">10 min</button>
        </div>
        <div style="display:flex;justify-content:center;margin-top:8px;gap:8px;flex-wrap:wrap;">
          <button id="breathing-quick" style="background:#1d73c5;color:#ffffff;border:1px solid #1d73c5;border-radius:999px;padding:10px 18px;font-size:14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;box-shadow:0 1px 3px rgba(0,0,0,0.08);">
            <i class="fa-solid fa-bolt" style="font-size:13px;color:#ffffff;"></i>
            Quick start
          </button>
        </div>
      `;
      const durationBtns = Array.from(controls.querySelectorAll('.breath-duration'));
      const highlight = (activeBtn) => {
        durationBtns.forEach((b) => {
          const isActive = b === activeBtn;
          b.style.background = isActive ? '#1d73c5' : '#ffffff';
          b.style.color = isActive ? '#ffffff' : '#1d73c5';
          b.style.borderColor = isActive ? '#1d73c5' : '#d7dce5';
          const icon = b.querySelector('i');
          if (icon) icon.style.color = b.style.color;
        });
      };
      durationBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          const mins = parseInt(btn.dataset.duration || '1', 10);
          selectedDuration = Math.max(1, mins);
          highlight(btn);
        });
      });
      highlight(durationBtns[0]);
      const quickBtn = document.getElementById('breathing-quick');
      if (quickBtn) {
        quickBtn.addEventListener('click', () => {
          isQuickMode = true;
          totalDuration = Number.POSITIVE_INFINITY;
          startBreathing();
        });
      }
      // Allow tapping a duration to start as well if desired
      durationBtns.forEach((btn) => {
        btn.addEventListener('dblclick', () => {
          const mins = parseInt(btn.dataset.duration || '1', 10);
          selectedDuration = Math.max(1, mins);
          highlight(btn);
          isQuickMode = false;
          totalDuration = selectedDuration * 60000;
          startBreathing();
        });
      });
    };

    const renderActiveControls = () => {
      const controls = document.getElementById('breath-controls');
      if (!controls) return;
      controls.innerHTML = `
        <span id="breathing-duration-display" style="font-size:14px;font-weight:700;color:#3a3a3c;">${isQuickMode ? 'On-going' : `${Math.round(totalDuration / 1000)}s remaining`}</span>
        <button id="breathing-stop" style="background:#e4002b;color:#fff;border:1px solid #e4002b;border-radius:999px;padding:10px 14px;font-size:13px;font-weight:700;cursor:pointer;">Stop</button>
      `;
      const stop = document.getElementById('breathing-stop');
      if (stop) stop.addEventListener('click', resetBreathing);
    };

    const startBreathing = () => {
      let phaseIndex = 0;
      setBubbleScale(0.9, 0);
      const sessionStart = performance.now();
      const sessionEnd = isQuickMode ? Number.POSITIVE_INFINITY : sessionStart + totalDuration;
      renderActiveControls();
      const runPhase = () => {
        const elapsed = performance.now() - sessionStart;
        if (!isQuickMode && elapsed >= totalDuration) {
          clearTimeout(breathTimeout);
          clearInterval(breathSessionInterval);
          if (breathLabel) breathLabel.textContent = 'Done';
          if (breathCounter) breathCounter.textContent = '';
          setBubbleScale(0.9, 300);
          return;
        }
        const phase = breathPhases[phaseIndex % breathPhases.length];
        setBubbleScale(phase.scale, phase.transition);
        if (breathLabel) breathLabel.textContent = phase.label;
        const seconds = phase.duration / 1000;
        let remaining = seconds;
        if (breathStatus) breathStatus.textContent = `${phase.label} (${seconds}s)`;
        if (breathCounter) breathCounter.textContent = remaining.toString();

        const tick = () => {
          remaining -= 1;
          if (remaining > 0) {
            if (breathCounter) breathCounter.textContent = remaining.toString();
            setTimeout(tick, 1000);
          }
        };
        setTimeout(tick, 1000);

        breathTimeout = setTimeout(() => {
          phaseIndex += 1;
          runPhase();
        }, phase.duration);
      };
      clearTimeout(breathTimeout);
      clearInterval(breathSessionInterval);
      const disp = document.getElementById('breathing-duration-display');
      const display = () => {
        if (isQuickMode) {
          if (disp) disp.textContent = 'On-going';
          return;
        }
        const remainingMs = sessionEnd - performance.now();
        const remainingSec = Math.max(0, Math.ceil(remainingMs / 1000));
        if (disp) {
          const mins = Math.floor(remainingSec / 60);
          const secs = remainingSec % 60;
          disp.textContent = mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')} remaining` : `${secs}s remaining`;
        }
      };
      display();
      breathSessionInterval = setInterval(display, 1000);
      const stopBtn = document.getElementById('breathing-stop');
      if (stopBtn) stopBtn.style.display = 'inline-flex';
      const controls = document.getElementById('breath-controls');
      if (controls) controls.classList.add('breathing-active');
      runPhase();
    };

    const resetBreathing = () => {
      clearTimeout(breathTimeout);
      clearInterval(breathSessionInterval);
      setBubbleScale(0.9, 300);
      if (breathLabel) breathLabel.textContent = 'Tap start';
      if (breathCounter) breathCounter.textContent = '4';
      isQuickMode = false;
      renderRestControls();
    };

    renderRestControls();

    const launchConfetti = () => {
      const colors = ['#95DA39', '#5DA20A', '#E4002B', '#3997dd'];
      for (let i = 0; i < 28; i += 1) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        piece.style.background = colors[i % colors.length];
        const startX = Math.random() * window.innerWidth;
        piece.style.left = `${startX}px`;
        piece.style.top = `${window.scrollY + 20}px`;
        piece.style.setProperty('--x', `${(Math.random() - 0.5) * 120}px`);
        piece.style.animationDelay = `${Math.random() * 0.1}s`;
        piece.style.transform = `rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(piece);
        setTimeout(() => piece.remove(), 1300);
      }
    };

    function scrollCarouselToStart(carousel) {
      if (!carousel) return;
      if (Math.abs(carousel.scrollLeft) < 1) return;
      const prevSnap = carousel.style.scrollSnapType;
      carousel.style.scrollSnapType = 'none';
      carousel.classList.add('scrolling-to-start');
      carousel.scrollTo({ left: 0, behavior: 'smooth' });
      setTimeout(() => {
        carousel.style.scrollSnapType = prevSnap;
        carousel.classList.remove('scrolling-to-start');
      }, 900);
    }

    const addBonusCard = (withAnimation = true) => {
      const rewardsSection = document.getElementById('rewards-section');
      if (rewardsSection) rewardsSection.classList.remove('is-hidden');
      const carousel = document.querySelector('.rewards-carousel');
      if (!carousel || carousel.dataset.bonusAdded === 'true') return;
      carousel.dataset.bonusAdded = 'true';
      localStorage.setItem('bonusRewardSaved', 'true');
      carousel.querySelector('.reward-empty')?.classList.add('is-hidden');
      document.body.dataset.bonusPending = 'done';

      const card = document.createElement('div');
      card.className = 'reward-card font-sans';
      card.dataset.rewardType = 'code';
      card.dataset.rewardCode = 'MOVE10';
      card.style.cssText = 'max-width:220px; background:#ffffff; border:1px solid #e5e5ea; border-radius:24px; padding:22px 18px; color:#3a3a3c; box-shadow:none; margin-bottom:10px; position:relative; z-index:5;';
      card.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;margin-bottom:16px;">
          <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg, #95DA39 0%, #5DA20A 100%);display:flex;align-items:center;justify-content:center;">
            <i class="fa-solid fa-gift reward-main-icon" style="font-size:24px;color:#ffffff;"></i>
          </div>
        </div>
        <div style="text-align:center; margin-bottom:18px;">
          <p class="reward-title" style="margin:0 0 2px 0; font-size:18px; font-weight:700; line-height:22px;">Bonusová odměna</p>
          <p class="reward-description" style="margin:0; font-size:14px; font-weight:600; line-height:18px; color:#6e6e73;">10% sleva na produkty Dr. Max.</p>
        </div>
        <div style="display:flex;justify-content:center;margin-bottom:10px;">
          <span class="claim-code-pill" style="display:inline-flex;align-items:center;gap:10px; background:#ffffff; color:#0d6fb8; border:1px solid #e5e5ea; border-radius:999px; padding:10px 18px; font-size:14px; font-weight:700;min-width:170px;justify-content:center;">
            <span style="letter-spacing:0.6px;">MOVE10</span>
            <button class="copy-code" data-code="MOVE10" aria-label="Kopírovat kód" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#0d6fb8;">
              <i class="fa-solid fa-copy" style="font-size:14px;"></i>
            </button>
          </span>
        </div>
        <p style="margin:0; font-size:13px; font-weight:600; color:#6e6e73; text-align:center;">Platí ještě 25 dní</p>
      `;

      if (carousel.firstElementChild) {
        carousel.insertBefore(card, carousel.firstElementChild);
      } else {
        carousel.appendChild(card);
      }
      requestAnimationFrame(() => scrollCarouselToStart(carousel));
      if (withAnimation) {
        card.style.opacity = '0';
        card.style.transform = 'translateY(16px) scale(0.97)';
        carousel.classList.add('reveal-card');
        requestAnimationFrame(() => {
          card.classList.add('bonus-card-pop', 'bonus-card-highlight');
          card.style.opacity = '';
          card.style.transform = '';
          setTimeout(() => {
            card.classList.remove('bonus-card-highlight');
            carousel.classList.remove('reveal-card');
          }, 1400);
        });
      }
      wireRewardActions(carousel);
    };

    const resetStamps = (options = {}) => {
      const { rotate = true, force = false } = options;
      if (!force && document.body.classList.contains('tutorial-active')) {
        return;
      }
      const stamps = document.querySelectorAll('.stamps-row .stamp-dot');
      const card = document.querySelector('.stamps-card');
      if (card && rotate) {
        card.classList.remove('turning');
        void card.offsetWidth;
        card.classList.add('turning');
      }
      setTimeout(() => {
        stamps.forEach((stamp) => {
          stamp.dataset.filled = '';
          stamp.classList.remove('stamp-dot-filled', 'stamp-gift-active', 'stamp-pop');
          if (!stamp.classList.contains('stamp-dot-disabled')) {
            stamp.querySelectorAll('i').forEach((icon) => icon.remove());
          } else {
            const giftIcon = stamp.querySelector('i');
            if (giftIcon) giftIcon.setAttribute('style', 'font-size:18px;color:#c0c4ce;');
          }
        });
        updateSeasonalVisibility();
        updateStampReadyState();
        localStorage.setItem('stampFillCount', '0');
      }, 320);
    };

    const openBonusModal = () => {
      const modal = document.getElementById('bonus-modal');
      if (!modal || modal.dataset.open === 'true') return;
      const bonusDesc = document.getElementById('bonus-modal-desc');
      if (bonusDesc) {
        const rewardText = localStorage.getItem('bonusRewardText') || '10% sleva na produkty Dr. Max.';
        bonusDesc.textContent = `Nasbírali jste 8 razítek. Vaše bonusová odměna je ${rewardText.replace(/\.$/, '')}.`;
      }
      modal.dataset.open = 'true';
      modal.classList.add('visible');
      document.body.classList.add('modal-open');
    };

    const closeBonusModal = () => {
      const modal = document.getElementById('bonus-modal');
      if (!modal || modal.dataset.open !== 'true') return;
      modal.dataset.open = 'false';
      modal.classList.remove('visible');
      document.body.classList.remove('modal-open');
      const bonusTitle = document.getElementById('bonus-reward-title');
      const bonusText = document.getElementById('bonus-reward-text');
      const currentStage = localStorage.getItem('bonusRewardStage') || 'first';
      const currentRewardText = currentStage === 'second'
        ? '15% sleva na produkty Dr. Max'
        : '10% sleva na produkty Dr. Max.';
      localStorage.setItem('bonusRewardSavedText', currentRewardText);
      if (currentStage !== 'second') {
        localStorage.setItem('bonusRewardStage', 'second');
        localStorage.setItem('bonusRewardTitle', 'Bonusová odměna');
        localStorage.setItem('bonusRewardText', '15% sleva na produkty Dr. Max');
      }
      if (bonusTitle) bonusTitle.textContent = 'Bonusová odměna';
      if (bonusText) {
        bonusText.textContent = localStorage.getItem('bonusRewardText') || '10% sleva na produkty Dr. Max.';
      }
      setTimeout(() => addBonusCard(true), 800);
      localStorage.removeItem('manualGeneratedCount');
      localStorage.removeItem('notificationStampCount');
      localStorage.removeItem('claimedStampCount');
      localStorage.removeItem('permissionsBonusCount');
      localStorage.removeItem('permissionsBonusApplied');
      document.body.dataset.stampBaseline = '';
      document.body.dataset.claimsRestored = '';
      document.body.dataset.notificationStampsRestored = '';
      resetStamps();
    };

    document.getElementById('bonus-modal-close')?.addEventListener('click', closeBonusModal);
    document.querySelector('#bonus-modal .bonus-close-x')?.addEventListener('click', closeBonusModal);
    document.getElementById('bonus-modal-overlay')?.addEventListener('click', closeBonusModal);

    const restoreManualStamps = () => {
      if (localStorage.getItem('permissionsGranted') !== 'true') return;
      const manualCount = parseInt(localStorage.getItem('manualGeneratedCount') || '0', 10);
      const bonusCount = parseInt(localStorage.getItem('permissionsBonusCount') || '0', 10);
      const notificationCount = parseInt(localStorage.getItem('notificationStampCount') || '0', 10);
      const storedFill = parseInt(localStorage.getItem('stampFillCount') || '0', 10);
      const notificationPending = localStorage.getItem('notificationFlow') === 'true'
        || localStorage.getItem('notificationStampPending') === 'true';
      const effectiveNotificationCount = notificationPending
        ? Math.max(0, notificationCount - 1)
        : notificationCount;
      const totalWithNotification = manualCount + bonusCount + effectiveNotificationCount;
      const targetTotal = Math.max(totalWithNotification, storedFill);
      if (!targetTotal) return;
      const existing = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
      const needed = Math.max(0, targetTotal - existing);
      if (needed > 0) {
        for (let i = 0; i < needed; i += 1) {
          addStamp({ animate: false });
        }
      }
    };

    const formatSteps = (value) => Number(value || 0).toLocaleString('en-US');

    const openDailyModal = () => {
      if (suppressDrawers) return;
      const modal = document.getElementById('daily-modal');
      if (!modal || modal.dataset.open === 'true') return;
      modal.dataset.open = 'true';
      modal.classList.add('visible');
      modal.style.display = 'flex';
      document.body.classList.add('modal-open');
    };

    const closeDailyModal = () => {
      const modal = document.getElementById('daily-modal');
      if (!modal) return;
      modal.dataset.open = 'false';
      modal.classList.remove('visible');
      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
    };

    // Daily goal drawer has no dismiss action.

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('showDailyModal') === '1') {
      if (!suppressDrawers) {
        requestAnimationFrame(() => openDailyModal());
      }
      urlParams.delete('showDailyModal');
      const next = `${window.location.pathname}${urlParams.toString() ? `?${urlParams}` : ''}`;
      window.history.replaceState({}, '', next);
    }
    const startModal = document.getElementById('start-modal');
    const startModalClose = document.getElementById('start-modal-close');
    if (urlParams.get('showStartModal') === '1') {
      if (localStorage.getItem('showTutorialOnLoad') === 'true' && localStorage.getItem('tutorialSeen') !== 'true') {
        localStorage.setItem('openStartAfterTutorial', 'true');
      } else if (!suppressDrawers) {
        requestAnimationFrame(() => {
          startModal?.classList.add('open');
          document.body.classList.add('modal-open');
        });
      }
      urlParams.delete('showStartModal');
      const next = `${window.location.pathname}${urlParams.toString() ? `?${urlParams}` : ''}`;
      window.history.replaceState({}, '', next);
    }
    startModalClose?.addEventListener('click', () => {
      startModal?.classList.remove('open');
      document.body.classList.remove('modal-open');
      setPermissionsGranted(false);
    });
    startModal?.addEventListener('click', (event) => {
      if (event.target === startModal) {
        startModal.classList.remove('open');
        document.body.classList.remove('modal-open');
        setPermissionsGranted(false);
      }
    });

    function updateDailyProgressTo(steps) {
      const dailyProgress = document.getElementById('daily-progress');
      const targetSteps = Number(dailyProgress?.dataset.target || localStorage.getItem('dailyGoalSteps') || '5000');
      const clamped = Math.max(0, Math.min(steps, targetSteps));
      const percent = targetSteps ? (clamped / targetSteps) * 100 : 0;
      const stepsLabel = document.getElementById('daily-steps-count');
      if (stepsLabel) {
        stepsLabel.textContent = `${formatSteps(clamped)} / ${formatSteps(targetSteps)}`;
      }
      const svg = document.querySelector('#daily-progress svg[data-progress]');
      const arc = document.querySelector('#daily-progress .arc-progress');
      const dot = document.querySelector('#daily-progress .arc-knob');
      if (svg) {
        svg.dataset.progress = `${percent}`;
        svg.dataset.animated = 'true';
      }
      if (arc && dot) {
        arc.setAttribute('stroke-dasharray', `${percent} ${100 - percent}`);
        const totalLen = arc.getTotalLength();
        const point = arc.getPointAtLength((percent / 100) * totalLen);
        dot.setAttribute('cx', point.x);
        dot.setAttribute('cy', point.y);
      }
    }

    let dailyCountdownTimer = null;
    const setDailyCompleteState = (active) => {
      const desc = document.getElementById('daily-desc');
      const completeMsg = document.getElementById('daily-complete-msg');
      const completePanel = document.getElementById('daily-complete-panel');
      const dailyProgress = document.getElementById('daily-progress');
      const completeSteps = document.getElementById('daily-complete-steps');
      if (!desc || !completeMsg) return;
      if (!desc.dataset.defaultText) {
        desc.dataset.defaultText = desc.textContent || '';
      }
      if (active) {
        desc.classList.add('is-hidden');
        completeMsg.classList.add('is-hidden');
        completePanel?.classList.add('is-visible');
        dailyProgress?.classList.add('is-hidden');
        completeSteps?.classList.remove('is-hidden');
      } else {
        desc.textContent = desc.dataset.defaultText || desc.textContent;
        desc.classList.remove('is-hidden');
        completeMsg.classList.add('is-hidden');
        completePanel?.classList.remove('is-visible');
        completeSteps?.classList.add('is-hidden');
      }
    };

    const updateDailyCountdown = () => {
      const countdown = document.getElementById('daily-countdown');
      const until = parseInt(localStorage.getItem('dailyCompleteUntil') || '0', 10);
      if (!countdown || !until) return;
      const now = Date.now();
      if (until <= now) {
        localStorage.removeItem('dailyCompleteUntil');
        localStorage.removeItem('dailyCompleted');
        setDailyCompleteState(false);
        if (dailyCountdownTimer) {
          clearInterval(dailyCountdownTimer);
          dailyCountdownTimer = null;
        }
        return;
      }
      const diff = until - now;
      const hours = Math.floor(diff / 3600000);
      const minutes = Math.floor((diff % 3600000) / 60000);
      countdown.textContent = `${hours} h ${String(minutes).padStart(2, '0')} min`;
    };

    const startDailyCountdown = () => {
      if (dailyCountdownTimer) {
        clearInterval(dailyCountdownTimer);
      }
      updateDailyCountdown();
      dailyCountdownTimer = setInterval(updateDailyCountdown, 60000);
    };

    const applyDailyGoal = (steps, discount) => {
      const target = Number(steps) || 5000;
      const discountValue = Number(discount) || 10;
      const title = document.getElementById('daily-title');
      const desc = document.getElementById('daily-desc');
      const goalLabel = document.getElementById('daily-goal-label');
      const dailyProgress = document.getElementById('daily-progress');
      if (title) title.textContent = `Ujít ${formatSteps(target)} kroků`;
      if (desc) {
        desc.textContent = `Ujděte dnes ${formatSteps(target)} kroků a získejte dnešní razítko.`;
      }
      if (goalLabel) {
        const label = target >= 1000
          ? `${(target / 1000).toFixed(target % 1000 === 0 ? 0 : 1)}k`
          : `${target}`;
        goalLabel.textContent = label;
      }
      if (dailyProgress) {
        dailyProgress.dataset.target = `${target}`;
      }
      localStorage.setItem('dailyGoalSteps', String(target));
      localStorage.setItem('dailyGoalDiscount', String(discountValue));
      if (dailyProgress && localStorage.getItem('permissionsGranted') === 'true') {
        dailyProgress.dataset.started = 'true';
        dailyProgress.classList.remove('is-hidden');
      }
      updateDailyProgressTo(parseInt(localStorage.getItem('dailyCurrentSteps') || '0', 10));
    };

    let selectedDailyOption = document.querySelector('#daily-modal .daily-option.is-selected');
    document.querySelectorAll('#daily-modal .daily-option').forEach((option) => {
      option.addEventListener('click', () => {
        document.querySelectorAll('#daily-modal .daily-option').forEach((btn) => btn.classList.remove('is-selected'));
        option.classList.add('is-selected');
        selectedDailyOption = option;
      });
    });

    const handleDailyApply = () => {
      const option = selectedDailyOption || document.querySelector('#daily-modal .daily-option');
      if (!option) return;
      const steps = option.dataset.steps || '5000';
      const discount = option.dataset.discount || '10';
      localStorage.setItem('dailyCurrentSteps', '0');
      applyDailyGoal(steps, discount);
      closeDailyModal();
      startDailyChallenge(Number(steps));
      if (localStorage.getItem('pendingPermissionStamps') === 'true') {
        openPermissionDrawer();
      }
    };
    document.getElementById('daily-modal-apply')?.addEventListener('click', handleDailyApply);
    window.handleDailyApply = handleDailyApply;

    let lastPermissionsState = null;
    document.querySelectorAll('.rewards-carousel .reward-card').forEach((card) => {
      const actions = card.querySelector('.reward-actions');
      if (actions && !card.dataset.inactiveActions) {
        card.dataset.inactiveActions = actions.innerHTML;
      }
    });
    const rewardsCarousel = document.querySelector('.rewards-carousel');
    const seedTutorialRewards = () => {
      if (!rewardsCarousel) return;
      if (rewardsCarousel.querySelector('[data-tutorial-reward="true"]')) return;
      const rewards = [
        { title: 'Sleva 5 %', desc: 'Na vybrané produkty', code: 'MOVE5' },
        { title: 'Sleva 10 %', desc: 'Na Dr. Max produkty', code: 'MOVE10' },
        { title: 'Doprava zdarma', desc: 'Na celý nákup', code: 'FREESHIP' }
      ];
      rewardsCarousel.querySelector('.reward-empty')?.classList.add('is-hidden');
      rewards.forEach((reward) => {
        const card = document.createElement('div');
        card.className = 'reward-card font-sans';
        card.dataset.rewardType = 'code';
        card.dataset.rewardCode = reward.code;
        card.dataset.tutorialReward = 'true';
        card.style.cssText = 'max-width:220px; background:#ffffff; border:1px solid #e5e5ea; border-radius:24px; padding:22px 18px; color:#3a3a3c; box-shadow:none; margin-bottom:10px; position:relative; z-index:5;';
        card.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:center;margin-bottom:16px;">
            <div style="width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg, #95DA39 0%, #5DA20A 100%);display:flex;align-items:center;justify-content:center;">
              <i class="fa-solid fa-gift reward-main-icon" style="font-size:24px;color:#ffffff;"></i>
            </div>
          </div>
          <div style="text-align:center; margin-bottom:18px;">
            <p class="reward-title" style="margin:0 0 2px 0; font-size:18px; font-weight:700; line-height:22px;">${reward.title}</p>
            <p class="reward-description" style="margin:0; font-size:14px; font-weight:600; line-height:18px; color:#6e6e73;">${reward.desc}</p>
          </div>
          <div style="display:flex;justify-content:center;margin-bottom:10px;">
            <span class="claim-code-pill" style="display:inline-flex;align-items:center;gap:10px; background:#ffffff; color:#0d6fb8; border:1px solid #e5e5ea; border-radius:999px; padding:10px 18px; font-size:14px; font-weight:700;min-width:170px;justify-content:center;">
              <span style="letter-spacing:0.6px;">${reward.code}</span>
              <button class="copy-code" data-code="${reward.code}" aria-label="Kopírovat kód" style="background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:#0d6fb8;">
                <i class="fa-solid fa-copy" style="font-size:14px;"></i>
              </button>
            </span>
          </div>
          <p style="margin:0; font-size:13px; font-weight:600; color:#6e6e73; text-align:center;">Platí ještě 25 dní</p>
        `;
        rewardsCarousel.appendChild(card);
      });
      wireRewardActions(rewardsCarousel);
    };
    const clearTutorialRewards = () => {
      if (!rewardsCarousel) return;
      rewardsCarousel.querySelectorAll('[data-tutorial-reward="true"]').forEach((card) => card.remove());
      const hasRewards = rewardsCarousel.querySelector('.reward-card');
      if (!hasRewards) {
        rewardsCarousel.querySelector('.reward-empty')?.classList.remove('is-hidden');
      }
    };

    const applyPermissionsState = (granted) => {
      const justGranted = localStorage.getItem('permissionsJustGranted') === 'true';
      const storedFillCount = parseInt(localStorage.getItem('stampFillCount') || '0', 10);
      const manualCount = parseInt(localStorage.getItem('manualGeneratedCount') || '0', 10);
      const notificationCount = parseInt(localStorage.getItem('notificationStampCount') || '0', 10);
      const bonusCount = parseInt(localStorage.getItem('permissionsBonusCount') || '0', 10);
      const hasExistingStamps = storedFillCount > 0 || manualCount > 0 || notificationCount > 0 || bonusCount > 0;
      const isFreshGrant = justGranted && !hasExistingStamps;
      const permissionCard = document.getElementById('entry-permission-card');
      const permissionToggle = document.getElementById('permissions-toggle');
      const sticky = document.getElementById('entry-challenge-sticky');
      const entryCard = document.getElementById('entry-permission-card');

      if (permissionCard) {
        permissionCard.style.display = granted ? 'none' : '';
      }
      if (permissionToggle) {
        permissionToggle.textContent = granted ? 'Oprávnění: Zapnuto' : 'Oprávnění: Vypnuto';
      }
      const dailyCard = document.getElementById('main-challenge-card');
      if (dailyCard) {
        dailyCard.style.display = granted ? '' : 'none';
      }
      const dailyProgress = document.getElementById('daily-progress');
      if (dailyProgress) {
        const started = dailyProgress.dataset.started === 'true';
        dailyProgress.classList.toggle('is-hidden', !started);
      }
      const seasonalProgress = document.getElementById('seasonal-progress');
      if (seasonalProgress) {
        const started = seasonalProgress.dataset.started === 'true';
        seasonalProgress.classList.toggle('is-hidden', !started);
      }
      if (sticky && granted) {
        sticky.style.display = 'none';
      }

      const setButtonState = (btn, enabled) => {
        if (!btn) return;
        btn.disabled = !enabled;
        btn.classList.toggle('btn-disabled', !enabled);
        if (enabled) {
          btn.style.background = '#47850a';
          btn.style.color = '#ffffff';
          btn.style.border = '1px solid #47850a';
          btn.style.boxShadow = '0 8px 18px rgba(53,107,9,0.25)';
          btn.style.cursor = 'pointer';
        } else {
          btn.style.background = '';
          btn.style.color = '';
          btn.style.border = '';
          btn.style.boxShadow = '';
          btn.style.cursor = '';
        }
        btn.querySelectorAll('i').forEach((icon) => {
          icon.style.color = enabled ? '#ffffff' : 'currentColor';
        });
      };

      document.querySelectorAll('.challenge-btn').forEach((btn) => {
        setButtonState(btn, granted);
        if (granted && lastPermissionsState === false) {
          btn.classList.remove('enable-pop');
          void btn.offsetWidth;
          btn.classList.add('enable-pop');
        }
      });

      if (!granted) {
        rewardsCarousel?.querySelectorAll('.reward-card[data-reward-type="code"]').forEach((card) => card.remove());
        rewardsCarousel?.querySelector('.reward-empty')?.classList.remove('is-hidden');
        rewardsCarousel?.removeAttribute('data-bonus-added');
        rewardsCarousel?.removeAttribute('data-bonusAdded');
        rewardsCarousel?.removeAttribute('data-bonusadded');
        rewardsCarousel?.dataset && (rewardsCarousel.dataset.bonusAdded = '');
        document.body.dataset.bonusPending = '';
        localStorage.removeItem('bonusRewardSaved');
        localStorage.removeItem('bonusRewardSavedText');
        localStorage.removeItem('bonusRewardStage');
      }
      if (!granted) {
        localStorage.removeItem('seasonalUnlocked');
        localStorage.removeItem('seasonalStarted');
        localStorage.removeItem('claimedStampCount');
        localStorage.removeItem('notificationStampCount');
        localStorage.removeItem('permissionsBonusApplied');
        localStorage.removeItem('permissionsBonusCount');
        localStorage.removeItem('manualGeneratedCount');
        localStorage.removeItem('bonusRewardStage');
        localStorage.setItem('stampFillCount', '0');
        document.body.dataset.suppressReady = '';
        document.body.dataset.stampBaseline = '';
        document.body.dataset.claimsRestored = '';
        document.body.dataset.notificationStampsRestored = '';
        const seasonalSection = document.getElementById('seasonal-section');
        if (seasonalSection) {
          seasonalSection.classList.add('is-hidden');
        }
        if (seasonalSticky) {
          seasonalSticky.style.display = 'none';
          seasonalSticky.classList.remove('is-hidden');
        }
        resetStamps({ rotate: false });
      }
      updateStampReadyState();
      if (granted) {
        if (isFreshGrant) {
          document.body.dataset.suppressReady = 'true';
          document.body.dataset.stampBaseline = '';
          localStorage.setItem('permissionsBonusApplied', 'true');
          localStorage.setItem('permissionsBonusCount', '4');
          resetStamps({ rotate: false });
          localStorage.removeItem('claimedStampCount');
          document.body.dataset.claimsRestored = '';
          document.body.dataset.notificationStampsRestored = '';
          localStorage.setItem('pendingPermissionStamps', 'true');
          document.body.dataset.suppressReady = '';
          requestAnimationFrame(() => openDailyModal());
          setTimeout(() => {
            if (localStorage.getItem('notificationStampPending') === 'true') {
              setTimeout(() => forceScrollToStampsCard(), 80);
              setTimeout(() => {
                addStamp();
                localStorage.removeItem('notificationStampPending');
              }, 300);
            }
          }, 2600);
        } else {
          const bonusCount = parseInt(localStorage.getItem('permissionsBonusCount') || '0', 10);
          if (bonusCount > 0) {
            restoreBonusStamps(bonusCount);
            restoreNotificationStamps();
          } else {
            restoreClaimedStamps();
            autoClaimAvailableStamps();
            restoreNotificationStamps();
          }
        }
        localStorage.removeItem('permissionsJustGranted');
      } else {
        localStorage.removeItem('permissionsJustGranted');
      }
      lastPermissionsState = granted;
    };

    const sticky = document.getElementById('entry-challenge-sticky');
    const entryCard = document.getElementById('entry-permission-card');
    const seasonalSticky = document.getElementById('seasonal-challenge-sticky');
    const seasonalSection = document.getElementById('seasonal-section');
    const setStickyVisible = (visible) => {
      if (!sticky) return;
      sticky.style.display = visible ? 'flex' : 'none';
    };
    const setSeasonalStickyVisible = (visible) => {
      if (!seasonalSticky) return;
      seasonalSticky.style.display = visible ? 'flex' : 'none';
    };

    const updateStickyImmediate = () => {
      if (!sticky || !entryCard) return;
      const rect = entryCard.getBoundingClientRect();
      const inView = rect.bottom > 0 && rect.top < window.innerHeight;
      setStickyVisible(!inView);
    };
    const updateSeasonalStickyImmediate = () => {
      if (!seasonalSticky || !seasonalSection) return;
      if (localStorage.getItem('seasonalStarted') === 'true') {
        setSeasonalStickyVisible(false);
        return;
      }
      seasonalSticky.classList.remove('is-hidden');
      if (seasonalSection.classList.contains('is-hidden')) {
        setSeasonalStickyVisible(false);
        return;
      }
      const rect = seasonalSection.getBoundingClientRect();
      const inView = rect.bottom > 0 && rect.top < window.innerHeight;
      setSeasonalStickyVisible(!inView);
    };

    let stickyObserver = null;
    if (entryCard && sticky) {
      stickyObserver = new IntersectionObserver((entries) => {
        const granted = localStorage.getItem('permissionsGranted') === 'true';
        if (granted) {
          setStickyVisible(false);
          return;
        }
        setStickyVisible(!entries[0].isIntersecting);
      }, { threshold: 0.15 });
      stickyObserver.observe(entryCard);
    }
    let seasonalObserver = null;
    if (seasonalSection && seasonalSticky) {
      seasonalObserver = new IntersectionObserver((entries) => {
        if (localStorage.getItem('seasonalStarted') === 'true') {
          setSeasonalStickyVisible(false);
          return;
        }
        if (seasonalSection.classList.contains('is-hidden')) {
          setSeasonalStickyVisible(false);
          return;
        }
        setSeasonalStickyVisible(!entries[0].isIntersecting);
      }, { threshold: 0.15 });
      seasonalObserver.observe(seasonalSection);
    }

    const permissionsToggle = document.getElementById('permissions-toggle');
    const syncPermissionsState = () => {
      const granted = localStorage.getItem('permissionsGranted') === 'true';
      applyPermissionsState(granted);
      if (!granted) {
        updateStickyImmediate();
      } else {
        setStickyVisible(false);
      }
      updateSeasonalStickyImmediate();
    };

    permissionsToggle?.addEventListener('click', () => {
      const granted = localStorage.getItem('permissionsGranted') === 'true';
      if (granted) return;
      localStorage.setItem('permissionsGranted', 'true');
      localStorage.setItem('permissionsJustGranted', 'true');
      syncPermissionsState();
    });

    syncPermissionsState();

    if (localStorage.getItem('openDailyOnReturn') === 'true') {
      localStorage.removeItem('openDailyOnReturn');
      requestAnimationFrame(() => openDailyModal());
    }

    if (localStorage.getItem('permissionsGranted') === 'true') {
      const dailyProgress = document.getElementById('daily-progress');
      const savedSteps = parseInt(localStorage.getItem('dailyCurrentSteps') || '0', 10);
      const savedGoal = parseInt(localStorage.getItem('dailyGoalSteps') || '0', 10);
      const savedDiscount = parseInt(localStorage.getItem('dailyGoalDiscount') || '0', 10);
      if (savedGoal) {
        applyDailyGoal(savedGoal, savedDiscount || 10);
      }
      if (dailyProgress) {
        dailyProgress.dataset.started = 'true';
        dailyProgress.classList.remove('is-hidden');
        if (savedGoal) {
          dailyProgress.dataset.target = `${savedGoal}`;
        }
        updateDailyProgressTo(savedSteps || 0);
      }
      if (savedGoal && savedSteps >= savedGoal) {
        localStorage.setItem('dailyCompleted', 'true');
        if (!localStorage.getItem('dailyCompleteUntil')) {
          const nextMidnight = new Date();
          nextMidnight.setHours(24, 0, 0, 0);
          localStorage.setItem('dailyCompleteUntil', String(nextMidnight.getTime()));
        }
        setDailyCompleteState(true);
        startDailyCountdown();
      }
    }
    if (localStorage.getItem('dailyCompleted') === 'true') {
      setDailyCompleteState(true);
      startDailyCountdown();
    }

    const stampParams = new URLSearchParams(window.location.search);
    updateSeasonalVisibility();
    updateStampReadyState();
    updateSeasonalStickyImmediate();
    restoreManualStamps();
    if (stampParams.get('addStamp') === '1') {
      addNotificationStamp();
      stampParams.delete('addStamp');
      const hash = window.location.hash || '';
      const next = `${window.location.pathname}${stampParams.toString() ? `?${stampParams}` : ''}${hash}`;
      window.history.replaceState({}, '', next);
    }

    if (localStorage.getItem('notificationFlow') === 'true') {
      runNotificationFlow();
    }
    const filledCount = document.querySelectorAll('.stamps-row .stamp-dot-filled').length;
    if (localStorage.getItem('bonusRewardSaved') !== 'true' && filledCount === 0) {
      localStorage.setItem('bonusRewardStage', 'first');
      localStorage.setItem('bonusRewardText', '10% sleva na produkty Dr. Max.');
      if (bonusTitle) bonusTitle.textContent = 'Bonusová odměna';
      if (bonusText) bonusText.textContent = '10% sleva na produkty Dr. Max.';
    }
    if (localStorage.getItem('bonusRewardSaved') === 'true') {
      addBonusCard(false);
    }

    document.getElementById('generate-stamps')?.addEventListener('click', () => {
      generateStamps(3);
    });

    const tutorialSteps = [
      {
        id: 'daily',
        target: '#main-challenge-card',
        step: '2-1',
        text: 'Takhle vypadá váš denní cíl.'
      },
      {
        id: 'stamps',
        target: '#stamps-card',
        step: '2-2',
        text: 'Tady sbíráte razítka za splnění cíle.'
      },
      {
        id: 'bonus',
        target: '#bonus-reward-card',
        step: '2-3',
        text: 'Bonusová odměna čeká pod kartou razítek.'
      },
      {
        id: 'reward',
        target: '#rewards-section',
        step: '2-4',
        text: 'A takhle to bude vypadat, když je odměna připravená.'
      }
    ];

    let tutorialIndex = 0;
    const tutorialOverlay = document.getElementById('tutorial-overlay');
    const tutorialMaskHole = document.getElementById('tutorial-mask-hole');
    const tutorialMasks = {
      top: document.querySelector('.tutorial-mask[data-mask="top"]'),
      left: document.querySelector('.tutorial-mask[data-mask="left"]'),
      right: document.querySelector('.tutorial-mask[data-mask="right"]'),
      bottom: document.querySelector('.tutorial-mask[data-mask="bottom"]')
    };
    const tutorialHighlight = document.getElementById('tutorial-highlight');
    const tutorialCard = document.getElementById('tutorial-card');
    const tutorialStepLabel = document.getElementById('tutorial-step');
    const tutorialText = document.getElementById('tutorial-text');
    const tutorialNext = document.getElementById('tutorial-next');
    const tutorialStepper = document.getElementById('tutorial-stepper');
    const tutorialSkip = document.getElementById('tutorial-skip');
    const seedTutorialStamps = () => {
      localStorage.setItem('manualGeneratedCount', '0');
      localStorage.setItem('stampFillCount', '0');
      localStorage.setItem('notificationStampCount', '0');
      localStorage.setItem('permissionsBonusCount', '0');
      resetStamps({ rotate: false });
      const tutorialDots = Array.from(document.querySelectorAll('.stamps-row .stamp-dot:not(.stamp-dot-disabled)'));
      tutorialDots.slice(0, 3).forEach((dot) => {
        dot.dataset.filled = 'true';
        dot.classList.add('stamp-dot-filled');
        if (!dot.querySelector('i')) {
          const icon = document.createElement('i');
          icon.className = 'fa-solid fa-check stamp-icon';
          dot.appendChild(icon);
        }
      });
      updateStampReadyState();
    };

    const clearTutorialStamps = () => {
      localStorage.setItem('manualGeneratedCount', '0');
      localStorage.setItem('stampFillCount', '0');
      localStorage.setItem('notificationStampCount', '0');
      localStorage.setItem('permissionsBonusCount', '0');
      resetStamps({ rotate: false, force: true });
      updateStampReadyState();
    };

    const positionTutorial = (step) => {
      const target = document.querySelector(step.target);
      if (!target || !tutorialHighlight || !tutorialCard) return;
      const prevBodyOverflow = document.body.style.overflow;
      const prevHtmlOverflow = document.documentElement.style.overflow;
      document.body.style.overflow = 'auto';
      document.documentElement.style.overflow = 'auto';
      target.scrollIntoView({ behavior: 'auto', block: 'center' });
      setTimeout(() => {
        document.body.style.overflow = prevBodyOverflow;
        document.documentElement.style.overflow = prevHtmlOverflow;
      }, 80);
      const rect = target.getBoundingClientRect();
      const pad = 8;
      const targetRadius = parseFloat(window.getComputedStyle(target).borderRadius || '0') || 0;
      const highlightRadius = Math.max(24, targetRadius + pad);
      tutorialHighlight.style.borderRadius = `${highlightRadius}px`;
      tutorialHighlight.style.top = `${Math.max(8, rect.top - pad)}px`;
      tutorialHighlight.style.left = `${Math.max(8, rect.left - pad)}px`;
      tutorialHighlight.style.width = `${Math.max(0, rect.width + pad * 2)}px`;
      tutorialHighlight.style.height = `${Math.max(0, rect.height + pad * 2)}px`;
      const highlightTop = Math.max(0, rect.top - pad);
      const highlightLeft = Math.max(0, rect.left - pad);
      const highlightWidth = Math.max(0, rect.width + pad * 2);
      const highlightHeight = Math.max(0, rect.height + pad * 2);
      const highlightRight = highlightLeft + highlightWidth;
      const highlightBottom = highlightTop + highlightHeight;
      if (tutorialMasks.top) {
        tutorialMasks.top.style.top = '0';
        tutorialMasks.top.style.left = '0';
        tutorialMasks.top.style.right = '0';
        tutorialMasks.top.style.height = `${highlightTop}px`;
      }
      if (tutorialMasks.left) {
        tutorialMasks.left.style.top = `${highlightTop}px`;
        tutorialMasks.left.style.left = '0';
        tutorialMasks.left.style.width = `${highlightLeft}px`;
        tutorialMasks.left.style.height = `${highlightHeight}px`;
      }
      if (tutorialMasks.right) {
        tutorialMasks.right.style.top = `${highlightTop}px`;
        tutorialMasks.right.style.right = '0';
        tutorialMasks.right.style.left = `${highlightRight}px`;
        tutorialMasks.right.style.height = `${highlightHeight}px`;
      }
      if (tutorialMasks.bottom) {
        tutorialMasks.bottom.style.top = `${highlightBottom}px`;
        tutorialMasks.bottom.style.left = '0';
        tutorialMasks.bottom.style.right = '0';
        tutorialMasks.bottom.style.bottom = '0';
      }
      if (tutorialMaskHole) {
        const r = Math.min(highlightRadius, highlightWidth / 2, highlightHeight / 2);
        tutorialMaskHole.setAttribute('x', `${highlightLeft}`);
        tutorialMaskHole.setAttribute('y', `${highlightTop}`);
        tutorialMaskHole.setAttribute('width', `${highlightWidth}`);
        tutorialMaskHole.setAttribute('height', `${highlightHeight}`);
        tutorialMaskHole.setAttribute('rx', `${r}`);
        tutorialMaskHole.setAttribute('ry', `${r}`);
      }

      const cardWidth = tutorialCard.offsetWidth || 220;
      const cardHeight = tutorialCard.offsetHeight || 110;
      let cardTop = rect.top - cardHeight - 12;
      if (cardTop < 12) {
        cardTop = rect.bottom + 12;
      }
      if (tutorialStepper) {
        const stepperRect = tutorialStepper.getBoundingClientRect();
        const stepperTop = stepperRect.top;
        if (cardTop + cardHeight > stepperTop - 12) {
          cardTop = Math.max(12, stepperTop - cardHeight - 12);
        }
      }
      let cardLeft = rect.left;
      if (cardLeft + cardWidth > window.innerWidth) {
        cardLeft = window.innerWidth - cardWidth - 16;
      }
      if (cardLeft < 12) cardLeft = 12;
      if (cardTop < 12) cardTop = 12;
      tutorialCard.style.top = `${cardTop}px`;
      tutorialCard.style.left = `${cardLeft}px`;
    };

    const showTutorialStep = (index) => {
      const step = tutorialSteps[index];
      if (!step) return;
      if (tutorialStepLabel) tutorialStepLabel.textContent = step.step;
      if (tutorialText) tutorialText.textContent = step.text;
      if (tutorialNext) {
        tutorialNext.textContent = index === tutorialSteps.length - 1 ? 'Pokračovat' : 'Další';
      }
      document.querySelectorAll('#tutorial-stepper-bar .tutorial-dot').forEach((dot, dotIndex) => {
        dot.classList.toggle('is-active', dotIndex === index);
      });
      positionTutorial(step);
    };

    const openTutorial = () => {
      if (!tutorialOverlay) return;
      tutorialOverlay.classList.add('is-visible');
      tutorialOverlay.setAttribute('aria-hidden', 'false');
      document.body.classList.add('tutorial-active');
      if (tutorialStepper) tutorialStepper.style.display = 'flex';
      tutorialIndex = 0;
      seedTutorialStamps();
      seedTutorialRewards();
      showTutorialStep(tutorialIndex);
    };

    const closeTutorial = () => {
      if (!tutorialOverlay) return;
      tutorialOverlay.classList.remove('is-visible');
      tutorialOverlay.setAttribute('aria-hidden', 'true');
      if (tutorialStepper) tutorialStepper.style.display = 'none';
      localStorage.setItem('tutorialSeen', 'true');
      document.body.classList.remove('tutorial-active');
      clearTutorialRewards();
      clearTutorialStamps();
      if (localStorage.getItem('openStartAfterTutorial') === 'true') {
        localStorage.removeItem('openStartAfterTutorial');
        if (!suppressDrawers) {
          startModal?.classList.add('open');
          document.body.classList.add('modal-open');
        }
      }
    };

    tutorialNext?.addEventListener('click', () => {
      tutorialIndex += 1;
      if (tutorialIndex >= tutorialSteps.length) {
        closeTutorial();
        return;
      }
      showTutorialStep(tutorialIndex);
    });
    tutorialSkip?.addEventListener('click', () => {
      closeTutorial();
    });

    window.addEventListener('resize', () => {
      if (!tutorialOverlay?.classList.contains('is-visible')) return;
      showTutorialStep(tutorialIndex);
    });

    window.addEventListener('load', () => {
      if (localStorage.getItem('tutorialSeen') === 'true') return;
      if (localStorage.getItem('showTutorialOnLoad') !== 'true') return;
      if (document.querySelector('.bonus-modal.visible') || document.querySelector('.start-modal.open') || document.querySelector('.permission-drawer.open')) {
        return;
      }
      localStorage.removeItem('showTutorialOnLoad');
      setTimeout(openTutorial, 300);
    });

    const startDailyChallenge = (targetOverride) => {
      const targetSteps = Number(targetOverride)
        || Number(localStorage.getItem('dailyGoalSteps') || '0')
        || Number(document.getElementById('daily-progress')?.dataset.target || '5000');
      const dailyProgress = document.getElementById('daily-progress');
      const goalLabel = document.getElementById('daily-goal-label');
      if (dailyProgress) {
        dailyProgress.dataset.started = 'true';
        dailyProgress.dataset.target = `${targetSteps}`;
        dailyProgress.classList.remove('is-hidden');
      }
      const dailyBtn = document.getElementById('daily-start-btn');
      if (dailyBtn) {
        dailyBtn.remove();
      }
      const stepsLabel = document.getElementById('daily-steps-count');
      if (stepsLabel) {
        stepsLabel.textContent = `0 / ${formatSteps(targetSteps)}`;
      }
      if (goalLabel) {
        const label = targetSteps >= 1000
          ? `${(targetSteps / 1000).toFixed(targetSteps % 1000 === 0 ? 0 : 1)}k`
          : `${targetSteps}`;
        goalLabel.textContent = label;
      }
      const svg = document.querySelector('#daily-progress svg[data-progress]');
      const arc = document.querySelector('#daily-progress .arc-progress');
      const dot = document.querySelector('#daily-progress .arc-knob');
      if (svg) {
        svg.dataset.progress = '0';
        svg.dataset.animated = 'true';
      }
      if (arc && dot) {
        arc.setAttribute('stroke-dasharray', '5 95');
        dot.setAttribute('cx', '340');
        dot.setAttribute('cy', '198');
      }
    };

    const animateDailyProgressTo = (steps, duration) => {
      const dailyProgress = document.getElementById('daily-progress');
      const targetSteps = Number(dailyProgress?.dataset.target || localStorage.getItem('dailyGoalSteps') || '5000');
      const startLabel = document.getElementById('daily-steps-count');
      const svg = document.querySelector('#daily-progress svg[data-progress]');
      const arc = document.querySelector('#daily-progress .arc-progress');
      const dot = document.querySelector('#daily-progress .arc-knob');
      if (!svg || !arc || !dot) {
        updateDailyProgressTo(steps);
        return;
      }
      const startPercent = parseFloat(svg.dataset.progress || '0');
      const target = Math.max(0, Math.min(steps, targetSteps));
      const endPercent = targetSteps ? (target / targetSteps) * 100 : 0;
      const currentSteps = Math.round((startPercent / 100) * targetSteps);
      const deltaSteps = Math.abs(target - currentSteps);
      const computedDuration = Math.min(2400, Math.max(600, deltaSteps * 0.25));
      const finalDuration = duration ?? computedDuration;
      const start = performance.now();
      const totalLen = arc.getTotalLength();
      const easeOut = (t) => 1 - Math.pow(1 - t, 3);

      const tick = (now) => {
        const t = Math.min(1, (now - start) / finalDuration);
        const eased = easeOut(t);
        const current = startPercent + (endPercent - startPercent) * eased;
        svg.dataset.progress = `${current}`;
        arc.setAttribute('stroke-dasharray', `${current} ${100 - current}`);
        const point = arc.getPointAtLength((current / 100) * totalLen);
        dot.setAttribute('cx', point.x);
        dot.setAttribute('cy', point.y);
        if (startLabel) {
          const stepsNow = Math.round((current / 100) * targetSteps);
          startLabel.textContent = `${formatSteps(stepsNow)} / ${formatSteps(targetSteps)}`;
        }
        if (t < 1) {
          requestAnimationFrame(tick);
        } else {
          updateDailyProgressTo(target);
          localStorage.setItem('dailyCurrentSteps', String(target));
        }
      };
      requestAnimationFrame(tick);
    };

    document.getElementById('daily-start-btn')?.addEventListener('click', (event) => {
      event.preventDefault();
      openDailyModal();
    });

    const startSeasonalChallenge = () => {
      const seasonalBtn = document.getElementById('seasonal-start-card');
      const seasonalProgress = document.getElementById('seasonal-progress');
      const seasonalLabel = document.getElementById('seasonal-progress-label');
      const seasonalPercent = document.getElementById('seasonal-progress-percent');
      const seasonalFill = document.getElementById('seasonal-progress-fill');
      if (seasonalProgress) {
        seasonalProgress.dataset.started = 'true';
        seasonalProgress.classList.remove('is-hidden');
      }
      if (seasonalLabel) seasonalLabel.textContent = '0 / 25 km';
      if (seasonalPercent) seasonalPercent.textContent = '0%';
      if (seasonalFill) seasonalFill.style.width = '0%';
      if (seasonalBtn) {
        seasonalBtn.remove();
      }
      localStorage.setItem('seasonalStarted', 'true');
      setSeasonalStickyVisible(false);
      if (seasonalSticky) {
        seasonalSticky.classList.add('is-hidden');
      }
    };

    document.getElementById('seasonal-start-btn')?.addEventListener('click', startSeasonalChallenge);
    document.getElementById('seasonal-start-card')?.addEventListener('click', startSeasonalChallenge);

    (() => {
      const overlay = document.getElementById('press-menu');
      const menu = overlay?.querySelector('.press-menu');
      const permissionsToggle = document.getElementById('press-permissions-toggle');
      if (!overlay || !menu) return;
      let pressTimer = null;
      let startX = 0;
      let startY = 0;

      const openMenu = () => {
        overlay.classList.add('open');
        overlay.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
        if (permissionsToggle) {
          permissionsToggle.checked = localStorage.getItem('permissionsGranted') === 'true';
        }
      };
      const closeMenu = () => {
        overlay.classList.remove('open');
        overlay.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
      };
      window.openPressMenu = openMenu;
      const clearPressTimer = () => {
        if (pressTimer) {
          clearTimeout(pressTimer);
          pressTimer = null;
        }
      };
      const shouldIgnore = (target) => target.closest('button, a, input, textarea, select, .press-menu');

      document.addEventListener('touchstart', (event) => {
        if (shouldIgnore(event.target)) return;
        const touchCount = event.touches.length;
        if (touchCount !== 2 && touchCount !== 1) {
          clearPressTimer();
          return;
        }
        const [t1, t2] = event.touches;
        if (touchCount === 1) {
          startX = t1.clientX;
          startY = t1.clientY;
          clearPressTimer();
          pressTimer = setTimeout(() => openMenu(), 4000);
          return;
        }
        startX = (t1.clientX + t2.clientX) / 2;
        startY = (t1.clientY + t2.clientY) / 2;
        clearPressTimer();
        pressTimer = setTimeout(() => openMenu(), 3000);
      }, { passive: true });
      document.addEventListener('touchmove', (event) => {
        if (!pressTimer) return;
        const touchCount = event.touches.length;
        if (touchCount !== 2 && touchCount !== 1) {
          clearPressTimer();
          return;
        }
        if (touchCount === 1) {
          const [t1] = event.touches;
          const dx = Math.abs(t1.clientX - startX);
          const dy = Math.abs(t1.clientY - startY);
          if (dx > 12 || dy > 12) {
            clearPressTimer();
          }
          return;
        }
        const [t1, t2] = event.touches;
        const x = (t1.clientX + t2.clientX) / 2;
        const y = (t1.clientY + t2.clientY) / 2;
        const dx = Math.abs(x - startX);
        const dy = Math.abs(y - startY);
        if (dx > 12 || dy > 12) {
          clearPressTimer();
        }
      }, { passive: true });
      document.addEventListener('touchend', clearPressTimer);
      document.addEventListener('touchcancel', clearPressTimer);
      overlay.addEventListener('click', (event) => {
        if (event.target === overlay) closeMenu();
      });
      overlay.querySelectorAll('[data-action]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const action = btn.dataset.action;
          closeMenu();
          if (action === 'close') return;
          if (action === 'reset') {
            localStorage.clear();
            localStorage.setItem('bonusRewardStage', 'first');
            localStorage.setItem('bonusRewardTitle', 'Bonusová odměna');
            localStorage.setItem('bonusRewardText', '10% sleva na produkty Dr. Max.');
            window.location.href = 'app-home.html';
            return;
          }
          if (action === 'lockscreen') {
            window.location.href = 'lockscreen-notification.html';
            return;
          }
          if (action === 'generate') {
            generateStamps(3);
            return;
          }
        });
      });
      permissionsToggle?.addEventListener('change', () => {
        setPermissionsGranted(permissionsToggle.checked);
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') closeMenu();
      });
    })();

    document.getElementById('menu-open-btn')?.addEventListener('click', () => {
      if (typeof window.openPressMenu === 'function') {
        window.openPressMenu();
      }
    });
    document.getElementById('settings-btn')?.addEventListener('click', () => {
      if (typeof window.openPressMenu === 'function') {
        window.openPressMenu();
      }
    });

  </script>

  <script src="https://kit.fontawesome.com/2c7f1c6cae.js" crossorigin="anonymous"></script>
</body>
</html>
